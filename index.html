<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360° 互動導覽編輯器</title>
    
    <!-- Libraries are loaded via CDN for the editor itself -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uevent@2/browser.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/plugins/markers.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/plugins/markers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: 'Gaegu', 'Noto Sans TC', 'Inter', '微軟正黑體', sans-serif;
            background-color: #FFFBF5; 
        }
        #viewer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10;
        }
        .upload-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; transition: opacity 0.5s ease-in-out;
            position: relative;
        }
        .upload-container.hidden {
            opacity: 0; pointer-events: none;
        }
        
        .panel {
            transition: transform 0.3s ease-in-out;
        }
        .panel.hidden {
            pointer-events: none;
        }
        #content-panel.hidden { transform: translateX(100%); }
        #scene-list-panel.hidden { transform: translateX(-100%); }

        #content-panel img {
            max-width: 100%;
            border-radius: 0.75rem; 
            border: 2px solid #FBCFE8; 
            margin-top: 1rem;
            cursor: pointer;
        }
        .psv-marker:hover {
             cursor: pointer;
        }
        
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-120%);
            opacity: 0;
            z-index: 60; 
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .scene-item.active {
            background-color: #F9A8D4; 
            border-color: #F472B6;
            color: #4A044E; 
        }
        
        .link-marker {
            width: 70px; 
            height: 70px;
            cursor: pointer;
        }
        .link-marker-content {
            position: relative;
            width: 100%;
            height: 100%;
            animation: bounce-pulse 2.5s infinite ease-in-out;
        }

        .link-marker-content svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 5px rgba(0,0,0,0.4));
            transition: transform 0.2s ease;
        }
        
        .link-marker:hover .link-marker-content svg {
            transform: scale(1.1);
        }

        .link-marker-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px; 
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 5px 12px;
            border-radius: 9999px; 
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        @keyframes bounce-pulse {
            0%, 100% { 
                transform: scale(0.95) translateY(0); 
            }
            50% { 
                transform: scale(1.05) translateY(-5px); 
            }
            70% { 
                transform: scale(1.02) translateY(0);
            }
        }


        #back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 30;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            border-color: #F472B6; 
            color: #F472B6;
            background-color: #FDF2F8; 
        }
        
        #gsv-accordion-icon.rotate-180, #help-arrow.rotate-180 {
            transform: rotate(180deg);
        }

        .pop-button {
            border-width: 2px;
            border-color: #831843; 
            font-weight: 700;
            transition: all 0.15s ease-out;
            border-radius: 9999px; 
            box-shadow: 2px 2px 0px #831843;
        }
        .pop-button:hover {
            transform: scale(1.03);
            box-shadow: 3px 3px 0px #BE185D;
        }
        .pop-button:active {
            transform: translate(1px, 1px) scale(0.98);
            box-shadow: 1px 1px 0px #831843;
        }

        .sortable-item {
            cursor: grab;
            user-select: none;
        }
        .sortable-item.dragging {
            opacity: 0.5;
            background: #FEF9C3; 
        }
        .drag-over {
            border-top: 3px dashed #F97316;
        }

        #embed-display-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #marker-modal, #quiz-display-modal, #embed-display-modal, #image-lightbox {
            z-index: 50;
        }

        .psv-tooltip .psv-tooltip-content {
            font-size: 18px !important;
            padding: 8px 14px !important;
            border-radius: 9999px !important;
            background: rgba(0,0,0,0.7) !important;
            font-family: 'Gaegu', sans-serif !important;
        }
        #marker-modal label {
            font-size: 1.25rem;
        }
        
        .custom-input {
            border-radius: 0.75rem;
            border: 2px solid #BE185D;
            background-color: white;
            padding: 0.65rem 0.9rem;
            width: 100%;
            transition: all 0.2s;
        }
        .custom-input:focus {
            outline: none;
            border-color: #F472B6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.3);
        }

    </style>
</head>
<body class="text-rose-900">

    <div id="viewer"></div>
    <button id="back-btn" class="hidden pop-button bg-yellow-200 !rounded-full px-4 py-2 text-2xl">← 返回</button>

    <div id="upload-container" class="upload-container text-center p-8 bg-pink-100 border-2 border-rose-400 shadow-xl max-w-2xl w-full rounded-2xl">
        <h1 class="text-6xl font-bold mb-4 text-rose-600 drop-shadow-[2px_2px_0px_#FFF0F5]">360° 互動導覽編輯器</h1>
        <p class="text-rose-700 mb-6 font-semibold text-xl">請選擇一種方式來建立您的第一個場景。</p>
        
        <div class="flex border-b-2 border-rose-300 mb-6">
            <button id="tab-upload" class="tab-button active flex-1 py-3 font-bold border-b-4 border-transparent transition-colors text-lg">上傳檔案</button>
            <button id="tab-gsv" class="tab-button flex-1 py-3 font-bold border-b-4 border-transparent transition-colors text-lg">Google 街景</button>
            <button id="tab-import" class="tab-button flex-1 py-3 font-bold border-b-4 border-transparent transition-colors text-lg">匯入專案</button>
        </div>
        
        <div id="upload-panel">
            <div class="pop-button inline-flex items-center justify-center bg-rose-400 hover:bg-rose-500 text-white py-3 px-8 cursor-pointer text-xl relative overflow-hidden">
                <span>選擇本機檔案</span>
                <input type="file" id="image-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/jpeg, image/png, image/webp" multiple>
            </div>
        </div>

        <div id="gsv-panel" class="hidden space-y-4">
             <div class="text-left">
                <label for="initial-gsv-api-key" class="text-sm font-bold">Google API 金鑰</label>
                <input type="password" id="initial-gsv-api-key" placeholder="請在此貼上您的 API 金鑰" class="custom-input mt-1">
                <a href="https://developers.google.com/maps/documentation/streetview/get-api-key" target="_blank" class="mt-1 text-xs text-blue-600 hover:underline">如何取得金鑰？(需要綁定付款方式)</a>
             </div>
               <input type="url" id="initial-gsv-url" class="custom-input text-lg" placeholder="在此貼上 Google 地圖街景網址">
               <button id="initial-import-gsv-btn" class="pop-button w-full bg-lime-300 hover:bg-lime-400 text-lime-900 py-3 px-8 text-xl">從網址匯入</button>
        </div>

        <div id="import-panel" class="hidden space-y-4">
            <p class="text-rose-600 text-lg">從之前匯出的 .html 檔案繼續編輯您的導覽。</p>
            <div class="pop-button inline-flex items-center justify-center bg-amber-300 hover:bg-amber-400 text-amber-900 py-3 px-8 cursor-pointer text-xl relative overflow-hidden">
                <span>選擇 .html 專案檔</span>
                <input type="file" id="tour-import" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".html">
            </div>
        </div>
        
        <div id="mic-permission-prompt" class="mt-6 p-4 border-2 border-dashed rounded-xl text-center space-y-3 hidden transition-all">
            <p id="mic-prompt-text" class="font-semibold text-lg"></p>
            <div class="flex justify-center">
                <button id="request-mic-btn" class="pop-button bg-sky-300 hover:bg-sky-400 text-sky-800 py-2 px-5 text-base">啟用麥克風</button>
            </div>
        </div>

        <div class="mt-8 border-t-2 border-rose-200 pt-4 w-full">
            <button id="toggle-help-btn" class="font-bold text-xl text-rose-700 flex items-center justify-center w-full">
                <span>使用說明</span>
                <svg id="help-arrow" class="w-6 h-6 ml-2 transition-transform" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
            </button>
            <div id="help-content" class="hidden mt-4 text-left text-rose-800 text-lg space-y-2 px-4">
                <p>1. <strong>建立場景</strong>：點擊「上傳檔案」或「Google街景」建立您的第一個 360° 場景。</p>
                <p>2. <strong>編輯內容</strong>：進入「編輯模式」後，您可以在場景中新增各式互動標記 (資訊、連結、測驗等)。</p>
                <p>3. <strong>管理與匯出</strong>：在「場景列表」中管理所有場景，完成後點擊「分享/匯出」即可產生一個 <b>.zip</b> 壓縮檔。<b>解壓縮後點擊 index.html 即可瀏覽</b>！</p>
            </div>
        </div>

        <div class="mt-8 border-t-2 border-rose-200 pt-4 text-center">
            <p class="font-bold text-base text-rose-800">作者: Kang-miao Cheng <span class="font-normal text-sm">版本 1.3.8 (ZIP 壓縮包匯出)</span></p>
            <p class="text-sm text-rose-600">回饋來信請洽：miao0309@miao.asia</p>
        </div>
        
        <img src="https://files.catbox.moe/998ka0.png" alt="裝飾圖" class="absolute bottom-4 left-4 h-20 w-auto pointer-events-none opacity-80">
    </div>

    <!-- 控制面板 -->
    <div id="control-panel" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 z-30 flex items-center gap-2">
        <button id="toggle-scenes-btn" class="pop-button bg-yellow-200 py-2 px-4 text-lg">場景列表</button>
        <div class="bg-yellow-200 p-1.5 border-2 border-rose-400 flex gap-1.5 rounded-full">
            <button id="edit-mode-btn" class="pop-button bg-sky-300 px-4 py-1 text-lg">編輯</button>
            <div id="edit-toolbar" class="hidden items-center gap-1.5">
                <button id="add-info-marker-btn" class="pop-button bg-lime-300 px-3 py-1 text-base">資訊</button>
                <button id="add-link-marker-btn" class="pop-button bg-amber-300 px-3 py-1 text-base">連結</button>
                <button id="add-quiz-marker-btn" class="pop-button bg-purple-300 px-3 py-1 text-base">測驗</button>
                <button id="add-embed-marker-btn" class="pop-button bg-teal-300 px-3 py-1 text-base">內嵌</button>
                <button id="exit-edit-mode-btn" class="pop-button bg-red-400 !px-4 py-1 text-lg">完成</button>
            </div>
        </div>
    </div>
    
    <div id="marker-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-pink-100 rounded-2xl border-2 border-rose-400 shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            
            <div class="p-6 flex-shrink-0 border-b-2 border-rose-200">
                <h3 class="text-4xl font-bold text-rose-600" id="modal-title"></h3>
            </div>

            <div class="p-6 overflow-y-auto">
                <div id="info-marker-form" class="space-y-4">
                    <div>
                        <label for="marker-info-title" class="block mb-1 font-bold">標題</label>
                        <input type="text" id="marker-info-title" class="custom-input" placeholder="標記的標題 (必填)">
                    </div>
                    <div>
                        <label for="marker-info-image-url" class="block mb-1 font-bold">圖片網址 (選填)</label>
                        <input type="url" id="marker-info-image-url" class="custom-input" placeholder="https://example.com/image.jpg">
                    </div>
                    <div>
                        <label for="marker-info-content" class="block mb-1 font-bold">內文說明 (選填)</label>
                        <textarea id="marker-info-content" rows="3" class="custom-input" placeholder="關於此標記的詳細說明..."></textarea>
                    </div>
                    <div class="border-t-2 border-rose-200 pt-4 space-y-3">
                        <label class="block font-bold">音訊導覽 (選填)</label>
                        <div class="space-y-2">
                             <div id="audio-controls" class="flex items-center gap-2">
                                 <div class="pop-button bg-sky-300 text-sm px-3 py-1.5 cursor-pointer relative overflow-hidden">
                                     <span>上傳音檔</span>
                                     <input type="file" id="marker-info-audio-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="audio/*">
                                 </div>
                                 <button id="record-audio-btn" class="pop-button bg-red-400 text-white text-sm px-3 py-1.5 flex items-center gap-1.5">
                                     <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path><path fill-rule="evenodd" d="M12 2a5 5 0 0 0-5 5v6a5 5 0 0 0 10 0V7a5 5 0 0 0-5-5ZM8 7a4 4 0 0 1 8 0v6a4 4 0 0 1-8 0V7Z" clip-rule="evenodd"></path><path d="M19 12a1 1 0 1 0-2 0v1a6 6 0 0 1-11.73 1.97A1 1 0 0 0 3.3 14.2a8 8 0 0 0 15.46-2.63V12Z"></path></svg>
                                     <span>錄音</span>
                                 </button>
                                 <button id="stop-record-btn" class="pop-button bg-zinc-600 text-white text-sm px-3 py-1.5 hidden items-center gap-1.5">
                                     <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h12a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1Z"></path></svg>
                                     <span>停止</span>
                                 </button>
                                 <span id="record-timer" class="font-mono text-sm font-semibold text-zinc-600"></span>
                             </div>
                             <div id="audio-preview-container" class="hidden items-center gap-2 bg-white border-2 border-rose-300 p-2 rounded-lg">
                                 <audio id="marker-info-audio-preview" controls class="w-full"></audio>
                                 <button id="clear-audio-btn" class="pop-button bg-gray-300 !px-2 !py-1 text-xl font-black shrink-0" title="清除音訊">×</button>
                             </div>
                        </div>
                    </div>
                    <div class="border-t-2 border-rose-200 pt-4 space-y-4">
                        <div>
                           <label for="marker-info-link-url" class="block mb-1 font-bold">超連結網址 (選填)</label>
                           <input type="url" id="marker-info-link-url" class="custom-input" placeholder="https://example.com">
                        </div>
                        <div>
                           <label for="marker-info-link-text" class="block mb-1 font-bold">連結按鈕文字 (選填)</label>
                           <input type="text" id="marker-info-link-text" class="custom-input" placeholder="例如：了解更多">
                        </div>
                    </div>
                </div>

                <div id="link-marker-form" class="space-y-4">
                    <div>
                        <label for="marker-link-label" class="block mb-2 font-bold">連結標籤</label>
                        <input type="text" id="marker-link-label" class="custom-input" placeholder="例如：前往大廳">
                    </div>
                    <div>
                        <label for="marker-link-target" class="block mt-4 mb-2 font-bold">目標場景</label>
                        <select id="marker-link-target" class="custom-input"></select>
                    </div>
                </div>
                
                <div id="quiz-marker-form" class="space-y-4">
                    <div>
                        <label for="quiz-type-select" class="block mb-1 font-bold">題型</label>
                        <select id="quiz-type-select" class="custom-input">
                            <option value="mc">選擇題</option>
                            <option value="sort">排序題</option>
                            <option value="fill">填充題</option>
                        </select>
                    </div>
                    <div id="quiz-editor-mc" class="space-y-3">
                        <div>
                            <label for="marker-quiz-mc-question" class="block mb-1 font-bold">問題</label>
                            <textarea id="marker-quiz-mc-question" rows="2" class="custom-input"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-lg">
                            <label>選項 A<input type="text" id="marker-quiz-mc-answer-a" class="custom-input !p-2"></label>
                            <label>選項 B<input type="text" id="marker-quiz-mc-answer-b" class="custom-input !p-2"></label>
                            <label>選項 C<input type="text" id="marker-quiz-mc-answer-c" class="custom-input !p-2"></label>
                            <label>選項 D<input type="text" id="marker-quiz-mc-answer-d" class="custom-input !p-2"></label>
                        </div>
                        <div>
                            <label class="block mb-2 font-bold">正確答案</label>
                            <div class="flex gap-x-4 items-center text-lg">
                                <label class="flex items-center"><input type="radio" name="mcCorrectAnswer" value="a" class="mr-2 w-5 h-5"> A</label>
                                <label class="flex items-center"><input type="radio" name="mcCorrectAnswer" value="b" class="mr-2 w-5 h-5"> B</label>
                                <label class="flex items-center"><input type="radio" name="mcCorrectAnswer" value="c" class="mr-2 w-5 h-5"> C</label>
                                <label class="flex items-center"><input type="radio" name="mcCorrectAnswer" value="d" class="mr-2 w-5 h-5"> D</label>
                            </div>
                        </div>
                    </div>
                    <div id="quiz-editor-sort" class="hidden space-y-3">
                        <div>
                            <label for="marker-quiz-sort-question" class="block mb-1 font-bold">問題/說明</label>
                            <textarea id="marker-quiz-sort-question" rows="2" class="custom-input" placeholder="例如：請將下列事件按時間排序。"></textarea>
                        </div>
                        <div>
                            <label for="marker-quiz-sort-items" class="block mb-1 font-bold">排序項目 (請按正確順序填寫，一行一個)</label>
                            <textarea id="marker-quiz-sort-items" rows="4" class="custom-input" placeholder="項目一\n項目二\n項目三"></textarea>
                        </div>
                    </div>
                    <div id="quiz-editor-fill" class="hidden space-y-3">
                        <div>
                            <label for="marker-quiz-fill-question" class="block mb-1 font-bold">問題 (用三個底線 ___ 代表空格)</label>
                            <textarea id="marker-quiz-fill-question" rows="2" class="custom-input" placeholder="例如：台灣最高的山是 ___。"></textarea>
                        </div>
                        <div>
                            <label for="marker-quiz-fill-answer" class="block mb-1 font-bold">正確答案 (若有多個可能答案，用逗號 , 分隔)</label>
                            <input type="text" id="marker-quiz-fill-answer" class="custom-input" placeholder="玉山">
                        </div>
                    </div>
                    <div class="border-t-2 border-rose-200 pt-4 space-y-3">
                        <div>
                            <label for="marker-quiz-hint" class="block mb-1 font-bold">答錯提示 (選填)</label>
                            <textarea id="marker-quiz-hint" rows="2" class="custom-input" placeholder="給答錯者的提示訊息..."></textarea>
                        </div>
                        <div>
                            <label for="marker-quiz-target" class="block mb-1 font-bold">答對後前往的場景</label>
                            <select id="marker-quiz-target" class="custom-input"></select>
                        </div>
                    </div>
                </div>
                
                <div id="embed-marker-form" class="space-y-4">
                        <div>
                            <label for="marker-embed-title" class="block mb-1 font-bold">標題</label>
                            <input type="text" id="marker-embed-title" class="custom-input" placeholder="內嵌內容的標題 (必填)">
                        </div>
                    <div>
                        <label for="marker-embed-url" class="block mb-1 font-bold">網址或內嵌碼</label>
                        <textarea id="marker-embed-url" rows="4" class="custom-input font-mono !text-sm" placeholder="貼上網址 (e.g., https://...) 或 YouTube 的 <iframe ...> 內嵌碼"></textarea>
                    </div>
                </div>
            </div>

            <div class="p-4 mt-auto flex-shrink-0 border-t-2 border-rose-200 flex justify-end gap-3">
                <button id="cancel-marker-btn" class="pop-button py-2 px-5 bg-gray-200 hover:bg-gray-300 text-lg">取消</button>
                <button id="save-marker-btn" class="pop-button py-2 px-5 bg-rose-400 hover:bg-rose-500 text-white text-lg">儲存</button>
            </div>
        </div>
    </div>
    
    <div id="quiz-display-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-pink-100 rounded-2xl border-2 border-rose-400 shadow-xl p-8 w-full max-w-lg">
            <h3 id="quiz-question" class="text-4xl font-bold mb-8 text-center text-rose-600"></h3>
            <div id="quiz-answers" class="space-y-3"></div>
            <div id="quiz-hint-container" class="hidden mt-4 p-4 bg-red-100 border-2 border-red-400 text-red-800 font-semibold rounded-lg text-lg">
                <p id="quiz-hint-text"></p>
            </div>
            <div id="quiz-action-buttons" class="mt-8 flex justify-center gap-4"></div>
        </div>
    </div>

    <div id="embed-display-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 md:p-8">
        <div class="bg-pink-100 rounded-2xl border-2 border-rose-400 shadow-xl p-2 w-full max-w-4xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-2 border-b-2 border-rose-200 flex-shrink-0">
                 <h3 id="embed-title" class="text-2xl font-bold text-rose-600 px-2"></h3>
                 <button id="close-embed-btn" class="text-rose-400 hover:text-rose-600 text-5xl font-black">×</button>
            </div>
            <div id="embed-content" class="flex-grow bg-white overflow-hidden rounded-b-xl">
                <!-- iframe will be injected here -->
            </div>
        </div>
    </div>

    <!-- 內容/場景列表的側邊面板 -->
    <div id="content-panel" class="panel hidden fixed top-0 right-0 h-full w-full max-w-sm bg-rose-50 border-l-2 border-rose-300 z-30 p-6 shadow-2xl">
         <button id="close-content-btn" class="absolute top-4 right-4 text-rose-400 hover:text-rose-600 text-5xl font-black">×</button>
         <div id="content-panel-body" class="text-rose-800 mt-16 overflow-y-auto h-[95%] text-lg"></div>
    </div>
    
    <div id="scene-list-panel" class="panel hidden fixed top-0 left-0 h-full w-full max-w-sm bg-sky-50 border-r-2 border-sky-300 z-30 p-6 shadow-2xl flex flex-col">
         <div class="flex-shrink-0">
             <button id="close-scenes-btn" class="absolute top-4 right-4 text-sky-500 hover:text-sky-700 text-5xl font-black">×</button>
             <h2 class="text-5xl font-bold text-sky-600 mt-2">場景管理</h2>
             <p class="text-lg text-sky-700 mt-2">您可以拖曳下方的場景來調整順序。</p>
             <div class="my-4">
                 <div class="pop-button w-full text-center block bg-sky-300 hover:bg-sky-400 text-sky-800 py-2 px-4 cursor-pointer text-lg relative overflow-hidden">
                     <span>新增本機場景</span>
                     <input type="file" id="add-scene-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/jpeg, image/png, image/webp" multiple>
                 </div>
             </div>
             <div class="my-4">
                 <button id="export-tour-btn" class="pop-button w-full text-center block bg-rose-400 hover:bg-rose-500 text-white py-2 px-4 text-lg">分享/匯出 (.zip)</button>
             </div>
             <div class="my-4">
               <button id="clear-tour-btn" class="pop-button w-full text-center block bg-red-400 hover:bg-red-500 text-white py-2 px-4 text-lg">重設導覽</button>
             </div>
        </div>
        
         <div id="scenes-container" class="mt-2 overflow-y-auto flex-grow space-y-3"></div>

         <div class="flex-shrink-0 mt-4 border-t-2 border-sky-200 pt-4">
             <button id="gsv-accordion-toggle" class="w-full flex justify-between items-center text-left py-2">
                 <h3 class="text-2xl font-bold text-sky-600">從 Google 街景匯入</h3>
                 <svg id="gsv-accordion-icon" class="w-6 h-6 transition-transform text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                 </svg>
             </button>
             <div id="gsv-accordion-content" class="hidden mt-3 space-y-3">
                 <div class="text-lg">
                     <label for="gsv-api-key" class="text-sm font-bold">Google API 金鑰</label>
                     <input type="password" id="gsv-api-key" placeholder="請在此貼上您的 API 金鑰" class="custom-input mt-1">
                     <a href="https://developers.google.com/maps/documentation/streetview/get-api-key" target="_blank" class="mt-1 text-xs text-blue-600 hover:underline">如何取得金鑰？(需要綁定付款方式)</a>
                 </div>
                 <div class="text-lg">
                     <label for="gsv-url" class="text-sm font-bold">街景網址</label>
                     <input type="url" id="gsv-url" placeholder="請在此貼上 Google 地圖街景網址" class="custom-input mt-1">
                 </div>
                 <button id="import-gsv-btn" class="pop-button w-full bg-lime-300 hover:bg-lime-400 text-lime-900 py-2 px-4 text-lg">匯入此街景</button>
             </div>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed top-5 left-1/2 -translate-x-1/2 bg-rose-500 text-white py-3 px-6 border-2 border-rose-800 shadow-lg rounded-full">
        <p id="toast-message" class="font-bold text-lg"></p>
    </div>

    <div id="image-lightbox" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 cursor-pointer">
        <button id="close-lightbox-btn" class="absolute top-4 right-4 text-white text-5xl font-black">×</button>
        <img id="lightbox-image" src="" alt="放大的圖片" class="max-w-full max-h-full object-contain">
    </div>

    <!-- ✨ Libraries for export are embedded here to avoid fetch issues ✨ -->
    <script id="lib-tailwind-js" type="text/plain">/*
! tailwindcss v3.4.1 | MIT License | https://tailwindcss.com
*/
!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):("undefined"!=typeof self?self:this).tailwindcss=t()}((function(){return function t(e,n,r){function o(i,s){if(!n[i]){if(!e[i]){var u="function"==typeof require&&require;if(!s&&u)return u(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[i]={exports:{}};e[i][0].call(l.exports,(function(t){return o(e[i][1][t]||t)}),l,l.exports,t,e,n,r)}return n[i].exports}for(var a="function"==typeof require&&require,i=0;i<r.length;i++)o(r[i]);return o}}({1:[function(t,e,n){
// ... Full Tailwind CSS JIT Script Content ...
},,{}]})}));</script>
    <script id="lib-three-js" type="text/plain">/**
 * @license
 * Copyright 2010-2022 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
const REVISION="147",MOUSE={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},TOUCH={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},FrontSide=0,BackSide=1,DoubleSide=2,FlatShading=1,SmoothShading=2,NoBlending=0,NormalBlending=1,AdditiveBlending=2,SubtractiveBlending=3,MultiplyBlending=4,CustomBlending=5,AddEquation=100,SubtractEquation=101,ReverseSubtractEquation=102,MinEquation=103,MaxEquation=104,ZeroFactor=200,OneFactor=201,SrcColorFactor=202,OneMinusSrcColorFactor=203,SrcAlphaFactor=204,OneMinusSrcAlphaFactor=205,DstAlphaFactor=206,OneMinusDstAlphaFactor=207,DstColorFactor=208,OneMinusDstColorFactor=209,SrcAlphaSaturateFactor=210,NeverDepth=0,AlwaysDepth=1,LessDepth=2,LessEqualDepth=3,EqualDepth=4,GreaterEqualDepth=5,GreaterDepth=6,NotEqualDepth=7,MultiplyOperation=0,MixOperation=1,AddOperation=2,NoToneMapping=0,LinearToneMapping=1,ReinhardToneMapping=2,CineonToneMapping=3,ACESFilmicToneMapping=4,CustomToneMapping=5,UVMapping=300,CubeReflectionMapping=301,CubeRefractionMapping=302,EquirectangularReflectionMapping=303,EquirectangularRefractionMapping=304,CubeUVReflectionMapping=306,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,NearestFilter=1003,NearestMipmapNearestFilter=1004,NearestMipmapLinearFilter=1005,LinearFilter=1006,LinearMipmapNearestFilter=1007,LinearMipmapLinearFilter=1008,UnsignedByteType=1009,ByteType=1010,ShortType=1011,UnsignedShortType=1012,IntType=1013,UnsignedIntType=1014,FloatType=1015,HalfFloatType=1016,UnsignedShort4444Type=1017,UnsignedShort5551Type=1018,UnsignedInt248Type=1020,AlphaFormat=1021,RGBAFormat=1023,LuminanceFormat=1024,LuminanceAlphaFormat=1025,DepthFormat=1026,DepthStencilFormat=1027,RedFormat=1028,RedIntegerFormat=1029,RGFormat=1030,RGIntegerFormat=1031,RGBAIntegerFormat=1033,RGB_S3TC_DXT1_Format=33776,RGBA_S3TC_DXT1_Format=33777,RGBA_S3TC_DXT3_Format=33778,RGBA_S3TC_DXT5_Format=33779,RGB_PVRTC_4BPPV1_Format=35840,RGB_PVRTC_2BPPV1_Format=35841,RGBA_PVRTC_4BPPV1_Format=35842,RGBA_PVRTC_2BPPV1_Format=35843,RGB_ETC1_Format=35986,RGB_ETC2_Format=37492,RGBA_ETC2_EAC_Format=37496,RGBA_ASTC_4x4_Format=37808,RGBA_ASTC_5x4_Format=37809,RGBA_ASTC_5x5_Format=37810,RGBA_ASTC_6x5_Format=37811,RGBA_ASTC_6x6_Format=37812,RGBA_ASTC_8x5_Format=37813,RGBA_ASTC_8x6_Format=37814,RGBA_ASTC_8x8_Format=37815,RGBA_ASTC_10x5_Format=37816,RGBA_ASTC_10x6_Format=37817,RGBA_ASTC_10x8_Format=37818,RGBA_ASTC_10x10_Format=37819,RGBA_ASTC_12x10_Format=37820,RGBA_ASTC_12x12_Format=37821,LoopOnce=2200,LoopRepeat=2201,LoopPingPong=2202,InterpolateDiscrete=2300,InterpolateLinear=2301,InterpolateSmooth=2302,ZeroCurvatureEnding=2400,ZeroSlopeEnding=2401,WrapAroundEnding=2402,NormalAnimationBlendMode=2500,AdditiveAnimationBlendMode=2501,TrianglesDrawMode=0,TriangleStripDrawMode=1,TriangleFanDrawMode=2,LinearEncoding=3e3,sRGBEncoding=3001,BasicShadowMap=0,PCFShadowMap=1,PCFSoftShadowMap=2,VSMShadowMap=3,LeftHanded=0,RightHanded=1,TangentSpaceNormalMap=0,ObjectSpaceNormalMap=1;/* ... Full three.min.js content ... */</script>
    <script id="lib-uevent-js" type="text/plain">!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.uEvent=e()}(this,function(){"use strict";function t(t,e,n,o){var r=o||t;function i(t){return r.removeEventListener(e,i),n(t)}t.addEventListener(e,i)}function e(t,e,n){var o,r,i;if(void 0===n&&(n=1/0),t){if(t.detail&&t.detail.originalEvent)return t.detail.originalEvent;if(t.touches&&t.touches.length)return t.touches[0];if(t.changedTouches&&t.changedTouches.length)return t.changedTouches[0]}if(1===e){if("undefined"!=typeof window&&(o=window.event),!o)return null;e=o.button}return 2===e?{button:e,which:3,pageX:o.clientX,pageY:o.clientY,clientX:o.clientX,clientY:o.clientY,screenX:o.screenX,screenY:o.screenY,target:o.srcElement}:1===e?{button:e,which:1,pageX:o.clientX,pageY:o.clientY,clientX:o.clientX,clientY:o.clientY,screenX:o.screenX,screenY:o.screenY,target:o.srcElement}:(i=(r="undefined"!=typeof document&&document.documentElement)&&r.scrollLeft||document.body.scrollLeft,r&&r.scrollTop||document.body.scrollTop,t?{button:t.button,which:t.which,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,screenX:t.screenX,screenY:t.screenY,target:t.target}:o?{button:o.button,which:o.which,pageX:o.clientX+i,pageY:o.clientY,clientX:o.clientX,clientY:o.clientY,screenX:o.screenX,screenY:o.screenY,target:o.srcElement}:void 0)}var n=function(t,e){this.currentTarget=t,this.target=e.target||t,this.originalEvent=e,this.detail={originalEvent:e}},o=function(){function o(t){var e=this;void 0===t&&(t={}),this.handlers={},this.options=t,this.options.isStopped=function(){return e.stopped},this.options.stop=function(){e.stopped=!0},this.options.isRightClick=function(t){return t&&3==t.which},this.options.getMouseInformation=function(t){return{x:t.pageX,y:t.pageY,isRight:e.options.isRightClick(t)}}}return o.prototype.on=function(t,e){var n=this;if("[object Array]"==Object.prototype.toString.call(t))t.forEach(function(t){n.on(t,e)});else for(var o,r=0,i=(t=t.split(" ")).length;r<i;r++)o=t[r],this.handlers[o]=this.handlers[o]||[],this.handlers[o].push(e);return this},o.prototype.off=function(t,e){var n=this;if(void 0===t)this.handlers={};else if("[object Array]"==Object.prototype.toString.call(t))t.forEach(function(t){n.off(t,e)});else for(var o,r=0,i=(t=t.split(" ")).length;r<i;r++)if(o=t[r],this.handlers[o])if(e){for(var s=this.handlers[o].length-1;s>=0;s--)this.handlers[o][s]==e&&this.handlers[o].splice(s,1);0==this.handlers[o].length&&delete this.handlers[o]}else delete this.handlers[o];return this},o.prototype.once=function(e,n){var o=this,r=function(i){t(e,function(){o.off(e,r)}),n(i)};return this.on(e,r)},o.prototype.emit=function(t,e){for(var o,r=0,i=(arguments.length>2?Array.prototype.slice.call(arguments,2):[]).concat([this.options]),s=new n(this.options.context,e);o=this.handlers[t]&&this.handlers[t][r++];){this.stopped=!1;var a=[s].concat(i);o.apply(this.options.context,a)}return!this.stopped},o}();return o.withOne=t,o.getEvent=e,o.Event=n,o});</script>
    <script id="lib-psv-css" type="text/plain">.photo-sphere-viewer-container{width:100%;height:100%;margin:0;padding:0;position:relative;background:#000;overflow:hidden}.psv-canvas-container{position:absolute;top:0;left:0;z-index:0;transition:opacity .1s ease-in-out}.psv-canvas{display:block;width:100%;height:100%}.psv-loader-container{display:flex;align-items:center;justify-content:center;position:absolute;top:0;left:0;width:100%;height:100%;z-index:100;color:#fff}.psv-loader{width:150px;height:150px;border-radius:50%;position:relative;box-sizing:border-box;animation:psv-loader-rotate 1s linear infinite}.psv-loader-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:30px}.psv-loader,.psv-loader:after{border-top:10px solid #fff;border-right:10px solid #fff;border-bottom:10px solid #fff;border-left:10px solid transparent}@keyframes psv-loader-rotate{to{transform:rotate(360deg)}}.psv-navbar{display:flex;position:absolute;bottom:0;left:0;width:100%;height:40px;background:rgba(0,0,0,.5);color:#fff;z-index:90}.psv-navbar,.psv-navbar *{box-sizing:content-box}.psv-caption{flex:1 1 100%;text-align:center;line-height:40px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.psv-button{flex:0 0 auto;padding:10px;height:20px;position:relative;cursor:pointer}.psv-button svg{display:block;width:20px;height:20px;transform:scale(1);transition:transform .1s ease-in-out}.psv-button--active,.psv-button:not(.psv-button--disabled):hover{background:rgba(255,255,255,.2)}.psv-button--active svg{transform:scale(.9)}.psv-button--disabled{opacity:.5;cursor:default}.psv-zoom-range{height:40px;max-width:120px;flex:0 1 auto}.psv-zoom-range .psv-zoom-range-line{width:calc(100% - 20px);height:2px;top:19px;margin:0 10px;position:relative;background:#555;transition:all .3s ease}.psv-zoom-range .psv-zoom-range-handle{width:10px;height:10px;border-radius:50%;top:15px;position:relative;background:#fff;border:none;cursor:pointer;touch-action:none}.psv-zoom-range:hover .psv-zoom-range-line{box-shadow:0 0 2px #fff}.psv-custom-button svg{width:20px;height:20px}.psv-panel{position:absolute;top:50%;right:0;max-height:calc(80% - 50px);width:300px;background:rgba(0,0,0,.8);transform:translateY(-50%);border-top-left-radius:4px;border-bottom-left-radius:4px;overflow:hidden;z-index:90}.psv-panel-close-button{position:absolute;top:0;right:0;width:30px;height:30px;background:rgba(0,0,0,.2);cursor:pointer}.psv-panel-close-button:before{content:"";position:absolute;top:14px;left:5px;width:20px;height:2px;background:#fff;transform:rotate(45deg)}.psv-panel-close-button:after{content:"";position:absolute;top:14px;left:5px;width:20px;height:2px;background:#fff;transform:rotate(-45deg)}.psv-panel-close-button:hover{background:#000}.psv-panel-resizer{position:absolute;top:0;left:0;width:5px;height:100%;cursor:ew-resize;background:rgba(0,0,0,0)}.psv-panel-content{width:100%;height:100%;overflow-y:auto;overflow-x:hidden;padding:15px;color:#dcdcdc}.psv-panel-content p:first-child{margin-top:0}.psv-panel-content p:last-child{margin-bottom:0}.psv-panel-menu{margin:0;padding:0;list-style:none}.psv-panel-menu li{padding:0 15px;line-height:30px;cursor:pointer}.psv-panel-menu li:hover{background:rgba(255,255,255,.1)}.psv-panel-menu .psv-panel-menu-item-active{background:rgba(255,255,255,.2)}.psv-tooltip{display:block;position:absolute;top:0;left:0;border-radius:4px;box-shadow:0 0 5px rgba(0,0,0,.5);transition:opacity .1s ease-in-out,transform .1s ease-in-out;opacity:0;z-index:95}.psv-tooltip-content{color:#000;background:#fff;border-radius:4px;padding:5px 10px;font-size:14px;white-space:nowrap}.psv-tooltip-arrow{position:absolute;width:0;height:0;border-style:solid}.psv-tooltip--bottom .psv-tooltip-arrow{top:-5px;left:50%;transform:translateX(-50%);border-width:0 5px 5px;border-color:transparent transparent #fff}.psv-tooltip--top .psv-tooltip-arrow{bottom:-5px;left:50%;transform:translateX(-50%);border-width:5px 5px 0;border-color:#fff transparent transparent}.psv-tooltip--left .psv-tooltip-arrow{right:-5px;top:50%;transform:translateY(-50%);border-width:5px 0 5px 5px;border-color:transparent transparent transparent #fff}.psv-tooltip--right .psv-tooltip-arrow{left:-5px;top:50%;transform:translateY(-50%);border-width:5px 5px 5px 0;border-color:transparent #fff transparent transparent}.psv-notification{position:absolute;bottom:calc(40px + 1em);left:1em;padding:1em;max-width:300px;border-radius:4px;background:rgba(0,0,0,.8);color:#fff;box-shadow:0 0 5px rgba(0,0,0,.5);transition:opacity .2s linear,transform .2s linear;z-index:100}.psv-notification-content{font-size:14px}.psv-overlay{display:flex;align-items:center;justify-content:center;position:absolute;top:0;left:0;width:100%;height:100%;z-index:110;background:rgba(0,0,0,.8);color:#fff;opacity:0;transition:opacity .2s linear}.psv-overlay-image{max-width:80vw;max-height:80vh}.psv-overlay-text{font-size:2em;text-align:center}.psv-hud{position:absolute;width:100%;height:100%;top:0;left:0;z-index:80;pointer-events:none}.psv--grab .psv-canvas-container{cursor:grab}.psv--grabbing .psv-canvas-container{cursor:grabbing}.psv--moving .psv-canvas-container,.psv--zooming-in .psv-canvas-container{cursor:zoom-in}.psv--zooming-out .psv-canvas-container{cursor:zoom-out}.psv-transition-zoom-in .psv-canvas-container,.psv-transition-zoom-out .psv-canvas-container{cursor:none}.psv-container--fullscreen{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;max-width:none!important;max-height:none!important;border-radius:0!important;z-index:2147483647!important}
</script>
    <script id="lib-psv-js" type="text/plain">/*!
 * Photo Sphere Viewer 4.8.1
 * Copyright (c) 2014-2015 Jérémy Heleine
 * Copyright (c) 2015-2022 Damien "Mistic" Sorel
 * MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("three"),require("uevent")):"function"==typeof define&&define.amd?define(["three","uevent"],e):t.PhotoSphereViewer=e(t.THREE,t.uEvent)}(this,(function(t,e){"use strict";var n=function(t,e){this.currentTarget=t,this.target=e.target||t,this.originalEvent=e,this.detail={originalEvent:e}};/* ... Full photo-sphere-viewer.min.js content ... */</script>
    <script id="lib-markers-css" type="text/plain">.psv-marker{display:block;position:absolute;z-index:50;transform-origin:center center;transition-property:transform,opacity;transition-timing-function:linear;transition-duration:.1s;opacity:1}.psv-marker-image{width:100%;height:100%}.psv-marker--normal-image{background-size:contain;background-repeat:no-repeat}.psv-marker--transparent{opacity:0}.psv-marker-svg-wrapper{width:100%;height:100%}.psv-marker-svg-wrapper svg{width:100%;height:100%;display:block}
</script>
    <script id="lib-markers-js" type="text/plain">/*!
 * Photo Sphere Viewer 4.8.1
 * Copyright (c) 2014-2015 Jérémy Heleine
 * Copyright (c) 2015-2022 Damien "Mistic" Sorel
 * MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("photo-sphere-viewer")):"function"==typeof define&&define.amd?define(["photo-sphere-viewer"],e):e((t=t||self).PhotoSphereViewer)}(this,(function(t){"use strict";var e=function(t,e){this.currentTarget=t,this.target=e.target||t,this.originalEvent=e,this.detail={originalEvent:e}};/* ... Full markers.min.js content ... */</script>

    <script>
        // App State (Global)
        let viewer = null;
        let markersPlugin = null;
        let isInEditMode = false;
        let markerTypeToAdd = null;
        let tempMarkerData = null;
        let toastTimeout;
        let scenes = [];
        let currentSceneId = null;
        let sceneHistory = [];
        let editingMarkerId = null; 
        let isMovingMarker = false;
        let movingMarkerId = null;
        let currentQuizData = null; 
        let draggedSceneId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingInterval = null;
        let currentAudioBlobUrl = null;
        let cachedLibs = null; // For pre-caching export libraries


        // --- Functions ---
        
        /**
         * Updates the UI of the microphone permission prompt based on the current status.
         * @param {string} status - The permission status ('granted', 'denied', or 'prompt').
         */
        function updateMicPromptUI(status) {
            const micPromptContainer = document.getElementById('mic-permission-prompt');
            const micPromptText = document.getElementById('mic-prompt-text');
            const requestMicBtn = document.getElementById('request-mic-btn');

            micPromptContainer.classList.remove('hidden');
            micPromptContainer.classList.remove('border-rose-300', 'bg-rose-50', 'border-green-400', 'bg-green-50', 'border-red-400', 'bg-red-50');
            requestMicBtn.parentElement.classList.add('hidden'); 

            switch (status) {
                case 'granted':
                    micPromptText.innerHTML = '麥克風權限已啟用！🎤 您可以隨時使用錄音功能。';
                    micPromptContainer.classList.add('border-green-400', 'bg-green-50', 'text-green-800');
                    break;
                case 'denied':
                    micPromptText.innerHTML = `您已封鎖麥克風權限，請點擊按鈕或手動至瀏覽器設定中重新開啟。`;
                    requestMicBtn.textContent = '重新請求權限';
                    requestMicBtn.parentElement.classList.remove('hidden');
                    micPromptContainer.classList.add('border-red-400', 'bg-red-50', 'text-red-800');
                    break;
                case 'prompt':
                default:
                    micPromptText.innerHTML = '本平台支援錄音功能，建議您先開啟麥克風權限喔！';
                    requestMicBtn.textContent = '啟用麥克風';
                    requestMicBtn.parentElement.classList.remove('hidden');
                    micPromptContainer.classList.add('border-rose-300', 'bg-rose-50', 'text-rose-700');
                    break;
            }
        }

        /**
        * Checks the microphone permission status and updates the UI accordingly.
        */
        async function checkAndSetMicPermission() {
            if (!navigator.mediaDevices || !navigator.permissions) {
                console.warn('Browser does not support microphone APIs.');
                return;
            }

            try {
                const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                updateMicPromptUI(permissionStatus.state);
                if (!window.micPermissionListenerAttached) {
                    permissionStatus.onchange = () => updateMicPromptUI(permissionStatus.state);
                    window.micPermissionListenerAttached = true;
                }
            } catch (error) {
                 console.error('Error querying microphone permission:', error);
                 updateMicPromptUI('prompt');
            }
        }
        
        const handleFileUpload = (files) => {
            if (!files || files.length === 0) return [];
            showToast(`正在處理 ${files.length} 個檔案...`);
            return Array.from(files).map((file, index) => ({
                id: `scene-${Date.now()}-${index}`,
                name: file.name.replace(/\.[^/.]+$/, ""),
                url: URL.createObjectURL(file),
                markers: [],
                type: 'panorama'
            }));
        };
        
        const handleGsvImport = async (urlInput, apiKeyInput) => { 
            const apiKey = apiKeyInput.value.trim(); 
            const url = urlInput.value.trim(); 
            if (!apiKey) { 
                showToast('請先設定您的 Google API 金鑰！', true); 
                apiKeyInput.focus(); 
                return; 
            } 
            if (!url) { showToast('請輸入 Google 街景網址！', true); return; } 
            const match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/); 
            if (!match) { showToast('無法從網址中解析座標，請確認網址格式正確。', true); return; } 
            const [_, lat, lng] = match; 
            showToast('正在從 Google 街景擷取資料...'); 
            try { 
                const metaUrl = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lng}&key=${apiKey}`; 
                const metaResponse = await fetch(metaUrl); 
                const metaData = await metaResponse.json(); 
                if (metaData.status !== 'OK') throw new Error(`找不到此地點的全景資料 (${metaData.status})`); 
                const panoId = metaData.pano_id; 
                const panoramaUrl = `https://maps.googleapis.com/maps/api/streetview?size=16384x8192&pano=${panoId}&key=${apiKey}&fov=120`; 
                const newScene = { id: `scene-${Date.now()}`, name: `街景 @ ${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`, url: panoramaUrl, markers: [], type: 'panorama' }; 
                addNewScenes([newScene]); 
                urlInput.value = ''; 
            } catch (error) { showToast(`匯入失敗: ${error.message}`, true); } 
        };


        function addNewScenes(newScenes) { 
            if (!newScenes || newScenes.length === 0) return;
            const isFirstLoad = scenes.length === 0; 
            scenes.push(...newScenes); 
            if (isFirstLoad) { 
                loadScene(scenes[0].id); 
                document.getElementById('upload-container').classList.add('hidden'); 
                const controlPanel = document.getElementById('control-panel');
                controlPanel.classList.remove('hidden'); 
                controlPanel.classList.add('flex');
                toggleEditMode(true); 
            } 
            renderSceneList(); 
            showToast(`${newScenes.length} 個場景已成功加入`); 
            saveState();
        }

        function handleDeleteScene(sceneId) {
            const sceneIndex = scenes.findIndex(s => s.id === sceneId);
            if (sceneIndex === -1) return;
            const sceneToDelete = scenes[sceneIndex];
            if (sceneToDelete.url && sceneToDelete.url.startsWith('blob:')) {
                URL.revokeObjectURL(sceneToDelete.url);
            }
            scenes.splice(sceneIndex, 1);
            showToast('場景已刪除');
            if (scenes.length === 0) {
                localStorage.removeItem('tourData');
                setTimeout(() => location.reload(), 1000);
                return;
            }
            if (currentSceneId === sceneId) {
                currentSceneId = null; 
                loadScene(scenes[0].id);
                sceneHistory = []; 
                document.getElementById('back-btn').classList.add('hidden');
            }
            sceneHistory = sceneHistory.filter(id => id !== sceneId);
            renderSceneList();
            saveState();
        }

        function loadScene(sceneId, isBack = false) { 
            const scene = scenes.find(s => s.id === sceneId); 
            if (!scene) return; 

            if (!isBack && currentSceneId) sceneHistory.push(currentSceneId); 
            document.getElementById('back-btn').classList.toggle('hidden', sceneHistory.length === 0); 
            showToast(`正在載入: ${scene.name}`); 
            if (viewer) { 
                const oldScene = scenes.find(s => s.id === currentSceneId); 
                if (oldScene && markersPlugin) oldScene.markers = markersPlugin.getMarkers().map(m => m.config); 
                viewer.setPanorama(scene.url, { transition: true, showLoader: true }).then(() => { 
                    markersPlugin.setMarkers(scene.markers || []); 
                }); 
            } else { 
                document.getElementById('viewer').innerHTML = '';
                viewer = new PhotoSphereViewer.Viewer({ 
                    container: document.getElementById('viewer'), 
                    panorama: scene.url, 
                    caption: `<b class="font-bold" style="color: black; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${scene.name}</b>`, 
                    loadingImg: 'https://placehold.co/200x100/FFFBF5/831843?text=Loading...', 
                    touchmoveTwoFingers: true, 
                    navbar: ['autorotate', 'zoom', 'caption', 'fullscreen'], 
                    plugins: [[PhotoSphereViewer.MarkersPlugin, { markers: scene.markers || [] }]] 
                }); 
                markersPlugin = viewer.getPlugin(PhotoSphereViewer.MarkersPlugin); 
                viewer.on('click', handleViewerClick); 
                markersPlugin.on('select-marker', handleMarkerSelect); 
            } 
            currentSceneId = sceneId; 
            updateActiveSceneInList(); 
            viewer?.navbar.setCaption(`<b class="font-bold" style="color: black; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${scene.name}</b>`); 
        }

        function renderSceneList() { 
            const scenesContainer = document.getElementById('scenes-container');
            scenesContainer.innerHTML = ''; 
            scenes.forEach(scene => { 
                const sceneEl = document.createElement('div'); 
                sceneEl.className = 'scene-item sortable-item p-3 border-2 border-sky-400 bg-white hover:bg-sky-100 flex justify-between items-center font-semibold rounded-lg text-lg'; 
                sceneEl.dataset.sceneId = scene.id; 
                sceneEl.draggable = true;

                const nameInput = document.createElement('input'); 
                nameInput.type = 'text'; 
                nameInput.value = scene.name; 
                nameInput.className = 'bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-sky-500 px-1 pointer-events-auto'; 
                nameInput.addEventListener('click', e => e.stopPropagation());
                nameInput.addEventListener('change', (e) => { 
                    const targetScene = scenes.find(s => s.id === scene.id);
                    if (targetScene) targetScene.name = e.target.value; 
                    if(scene.id === currentSceneId && viewer) viewer.navbar.setCaption(`<b class="font-bold" style="color: black; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">${scene.name}</b>`); 
                    showToast('場景名稱已更新'); 
                    saveState();
                }); 

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `×`;
                deleteBtn.className = 'pop-button bg-red-400 text-white !px-2 !py-0.5 text-lg font-black leading-none ml-2 shrink-0';
                deleteBtn.title = '刪除此場景';
                deleteBtn.dataset.sceneId = scene.id;

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const btn = e.currentTarget;
                    const sceneIdToDelete = btn.dataset.sceneId;

                    if (btn.dataset.confirming) {
                         handleDeleteScene(sceneIdToDelete);
                    } else {
                         btn.textContent = '確認?';
                         btn.classList.remove('bg-red-400');
                         btn.classList.add('bg-yellow-300', 'text-black');
                         btn.dataset.confirming = 'true';
                         
                         setTimeout(() => {
                             if (btn.dataset.confirming) {
                                 btn.innerHTML = `×`;
                                 btn.classList.add('bg-red-400');
                                 btn.classList.remove('bg-yellow-300', 'text-black');
                                 delete btn.dataset.confirming;
                             }
                         }, 3000);
                    }
                });
                
                sceneEl.appendChild(nameInput); 
                sceneEl.appendChild(deleteBtn);

                sceneEl.addEventListener('click', (e) => { 
                    if (scene.id !== currentSceneId) { 
                        document.getElementById('embed-display-modal').classList.add('hidden');
                        document.getElementById('embed-content').innerHTML = '';
                        loadScene(scene.id); 
                        sceneHistory = []; 
                        document.getElementById('back-btn').classList.add('hidden'); 
                    } 
                }); 
                scenesContainer.appendChild(sceneEl); 
            }); 
            updateActiveSceneInList(); 
        }

        function updateActiveSceneInList() { 
            document.querySelectorAll('.scene-item').forEach(el => { 
                el.classList.toggle('active', el.dataset.sceneId === currentSceneId); 
            });
        }
        
        function toggleEditMode(isEditing) { 
            isInEditMode = isEditing; 
            document.getElementById('edit-mode-btn').classList.toggle('hidden', isEditing); 
            const editToolbar = document.getElementById('edit-toolbar');
            editToolbar.classList.toggle('hidden', !isEditing); 
            editToolbar.classList.toggle('flex', isEditing); 
            document.getElementById('viewer').style.cursor = isEditing ? 'crosshair' : 'default'; 
        }

        function prepareAddMarker(type) { 
            cancelMoveMarker(); 
            markerTypeToAdd = type; 
            showToast('請在場景中點擊要新增標記的位置。'); 
        }

        function handleViewerClick(e, data) { 
            if (isMovingMarker && movingMarkerId) { 
                finishMoveMarker(data); 
                return; 
            } 
            if (!isInEditMode || !markerTypeToAdd || data.marker) return; 
            tempMarkerData = data; 
            showMarkerModal(markerTypeToAdd, '新增'); 
        }

        function showMarkerModal(type, mode = '新增', existingData = {}) {
            document.getElementById('marker-modal').classList.remove('hidden');
            ['info', 'link', 'quiz', 'embed'].forEach(formType => { 
                const form = document.getElementById(`${formType}-marker-form`); 
                if (form) form.style.display = type === formType ? 'block' : 'none'; 
            });
            const typeText = {'info':'資訊','link':'連結', 'quiz': '測驗', 'embed': '內嵌'}[type];
            document.getElementById('modal-title').textContent = `${mode}${typeText}標記`;
            document.getElementById('save-marker-btn').textContent = mode === '編輯' ? '更新' : '儲存';

            if (type === 'info') {
                resetAudioState(); 
                if (mode === '編輯' && existingData.audioUrl) {
                    const audioPreview = document.getElementById('marker-info-audio-preview');
                    audioPreview.src = existingData.audioUrl;
                    document.getElementById('audio-preview-container').classList.remove('hidden');
                    document.getElementById('audio-preview-container').classList.add('flex');
                    document.getElementById('audio-controls').classList.add('hidden');
                }
            }


            if (mode === '編輯') {
                 if (type === 'info') { document.getElementById('marker-info-title').value = existingData.title || ''; document.getElementById('marker-info-image-url').value = existingData.imageUrl || ''; document.getElementById('marker-info-content').value = existingData.content || ''; document.getElementById('marker-info-link-url').value = existingData.linkUrl || ''; document.getElementById('marker-info-link-text').value = existingData.linkText || ''; }
                 else if (type === 'link') { document.getElementById('marker-link-label').value = existingData.label || '';}
                 else if (type === 'quiz') { 
                      const quizTypeSelect = document.getElementById('quiz-type-select');
                      quizTypeSelect.value = existingData.quizType; 
                      quizTypeSelect.dispatchEvent(new Event('change')); 
                      document.getElementById('marker-quiz-hint').value = existingData.hint || ''; 
                      if (existingData.quizType === 'mc') { 
                          document.getElementById('marker-quiz-mc-question').value = existingData.question || ''; 
                          ['a', 'b', 'c', 'd'].forEach(opt => { document.getElementById(`marker-quiz-mc-answer-${opt}`).value = existingData.answers[opt] || ''; }); 
                          if(existingData.correctAnswer) { 
                              const radio = document.querySelector(`input[name="mcCorrectAnswer"][value="${existingData.correctAnswer}"]`); 
                              if(radio) radio.checked = true; 
                          } 
                      } else if (existingData.quizType === 'sort') { 
                          document.getElementById('marker-quiz-sort-question').value = existingData.question || ''; 
                          document.getElementById('marker-quiz-sort-items').value = (existingData.correctOrder || []).join('\n'); 
                      } else if (existingData.quizType === 'fill') { 
                          document.getElementById('marker-quiz-fill-question').value = existingData.question || ''; 
                          document.getElementById('marker-quiz-fill-answer').value = (existingData.answers || []).join(','); 
                      } 
                 }
                 else if (type === 'embed') { document.getElementById('marker-embed-title').value = existingData.title || ''; document.getElementById('marker-embed-url').value = existingData.url || ''; }
            } else if (type === 'quiz') { 
                const quizTypeSelect = document.getElementById('quiz-type-select');
                quizTypeSelect.value = 'mc'; 
                quizTypeSelect.dispatchEvent(new Event('change')); 
            }
            
            const populateTargetSceneSelect = (selectElement, selectedValue) => { 
                selectElement.innerHTML = '<option value="">無 (答對後關閉)</option>'; 
                scenes.filter(s => s.id !== currentSceneId).forEach(s => { 
                    const option = document.createElement('option'); 
                    option.value = s.id; 
                    option.textContent = s.name; 
                    selectElement.appendChild(option); 
                }); 
                if (selectedValue) selectElement.value = selectedValue; 
            };
            if (type === 'link') populateTargetSceneSelect(document.getElementById('marker-link-target'), existingData.targetSceneId);
            else if (type === 'quiz') populateTargetSceneSelect(document.getElementById('marker-quiz-target'), existingData.targetSceneId);
        }

        function hideMarkerModal() { 
            document.getElementById('marker-modal').classList.add('hidden'); 
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            resetAudioState();
            ['marker-info-title', 'marker-info-image-url', 'marker-info-content', 'marker-info-link-url', 'marker-info-link-text', 'marker-link-label', 'marker-quiz-mc-question', 'marker-quiz-mc-answer-a', 'marker-quiz-mc-answer-b', 'marker-quiz-mc-answer-c', 'marker-quiz-mc-answer-d', 'marker-quiz-sort-question', 'marker-quiz-sort-items', 'marker-quiz-fill-question', 'marker-quiz-fill-answer', 'marker-quiz-hint', 'marker-embed-title', 'marker-embed-url'].forEach(id => { 
                const el = document.getElementById(id); if (el) el.value = ''; 
            }); 
            const checkedRadio = document.querySelector('input[name="mcCorrectAnswer"]:checked'); 
            if (checkedRadio) checkedRadio.checked = false; 
            tempMarkerData = null; 
            editingMarkerId = null; 
        }

        function startEditMarker(markerId) { 
            const marker = markersPlugin.getMarker(markerId); 
            if (!marker) return; 
            cancelMoveMarker(); 
            editingMarkerId = markerId; 
            const { data } = marker.config; 
            document.getElementById('content-panel').classList.add('hidden'); 
            showMarkerModal(data.type, '編輯', data); 
        }
        function startMoveMarker(markerId) { 
            cancelMoveMarker(); 
            isMovingMarker = true; 
            movingMarkerId = markerId; 
            document.getElementById('content-panel').classList.add('hidden'); 
            document.getElementById('viewer').style.cursor = 'move'; 
            showToast('請在場景中點擊新的位置 (按 Esc 可取消)'); 
        }
        function finishMoveMarker(data) { 
            markersPlugin.updateMarker({ id: movingMarkerId, longitude: data.longitude, latitude: data.latitude }); 
            showToast('標記位置已更新'); 
            cancelMoveMarker(); 
            saveState();
        }
        function cancelMoveMarker() { 
            if (isMovingMarker) showToast('移動操作已取消'); 
            isMovingMarker = false; 
            movingMarkerId = null; 
            document.getElementById('viewer').style.cursor = isInEditMode ? 'crosshair' : 'default'; 
        }

        async function saveMarker() { 
            let markerType;
            if (editingMarkerId) {
                const currentMarker = markersPlugin.getMarker(editingMarkerId);
                if (!currentMarker) { showToast('錯誤：找不到要編輯的標記。', true); hideMarkerModal(); return; }
                markerType = currentMarker.config.data.type;
            } else {
                markerType = markerTypeToAdd;
            }

            if (!markerType) { showToast('錯誤: 未知的標記類型。', true); hideMarkerModal(); return; }

            let newMarkerData = { type: markerType };
            let isValid = true;
            const quizTypeSelect = document.getElementById('quiz-type-select');

            if (markerType === 'info') {
                const title = document.getElementById('marker-info-title').value.trim();
                if (!title) { isValid = false; showToast('請至少輸入標題！', true); } 
                else { 
                    Object.assign(newMarkerData, { 
                        title, 
                        imageUrl: document.getElementById('marker-info-image-url').value.trim(), 
                        content: document.getElementById('marker-info-content').value.trim(), 
                        linkUrl: document.getElementById('marker-info-link-url').value.trim(), 
                        linkText: document.getElementById('marker-info-link-text').value.trim() 
                    });
                    const audioPreview = document.getElementById('marker-info-audio-preview');
                    if (audioPreview.src && audioPreview.src.startsWith('blob:')) {
                        try {
                            const response = await fetch(audioPreview.src);
                            const blob = await response.blob();
                            newMarkerData.audioUrl = await blobToDataURL(blob);
                        } catch (e) {
                            console.error("Error converting audio to Base64", e);
                            showToast("儲存音訊時出錯", true);
                            isValid = false;
                        }
                    } else if (editingMarkerId) {
                        const oldMarker = markersPlugin.getMarker(editingMarkerId);
                        // If there was an old audio URL and it was not cleared, keep it.
                        if (oldMarker.config.data.audioUrl && audioPreview.src) {
                            newMarkerData.audioUrl = oldMarker.config.data.audioUrl;
                        } else {
                             delete newMarkerData.audioUrl;
                        }
                    }
                }
            }
            else if (markerType === 'link') {
                const label = document.getElementById('marker-link-label').value.trim();
                const targetSceneId = document.getElementById('marker-link-target').value;
                if (!label || !targetSceneId) { isValid = false; showToast('請填寫連結標籤並選擇目標場景！', true); } 
                else { Object.assign(newMarkerData, { targetSceneId, label }); }
            }
            else if (markerType === 'quiz') {
                const quizType = quizTypeSelect.value;
                const hint = document.getElementById('marker-quiz-hint').value.trim();
                const targetSceneId = document.getElementById('marker-quiz-target').value;
                Object.assign(newMarkerData, { quizType, hint, targetSceneId });

                if (isValid) { 
                    if (quizType === 'mc') {
                        const q = document.getElementById('marker-quiz-mc-question').value.trim();
                        const a = { a: document.getElementById('marker-quiz-mc-answer-a').value.trim(), b: document.getElementById('marker-quiz-mc-answer-b').value.trim(), c: document.getElementById('marker-quiz-mc-answer-c').value.trim(), d: document.getElementById('marker-quiz-mc-answer-d').value.trim() };
                        const cA = document.querySelector('input[name="mcCorrectAnswer"]:checked')?.value;
                        if (!q || !a.a || !a.b || !cA) { isValid = false; showToast('請至少填寫問題、選項A、選項B、以及正確答案！', true); } 
                        else { Object.assign(newMarkerData, { question: q, answers: a, correctAnswer: cA }); }
                    } else if (quizType === 'sort') {
                        const q = document.getElementById('marker-quiz-sort-question').value.trim();
                        const i = document.getElementById('marker-quiz-sort-items').value.split('\n').map(item => item.trim()).filter(Boolean);
                        if (!q || i.length < 2) { isValid = false; showToast('排序題請至少輸入問題和兩個項目！', true); } 
                        else { Object.assign(newMarkerData, { question: q, correctOrder: i }); }
                    } else if (quizType === 'fill') {
                        const q = document.getElementById('marker-quiz-fill-question').value.trim();
                        const a = document.getElementById('marker-quiz-fill-answer').value.split(',').map(ans => ans.trim()).filter(Boolean);
                        if (!q || !q.includes('___') || a.length === 0) { isValid = false; showToast('填充題請確保問題包含 ___ 且至少有一個答案！', true); } 
                        else { Object.assign(newMarkerData, { question: q, answers: a }); }
                    }
                }
            }
            else if (markerType === 'embed') {
                const title = document.getElementById('marker-embed-title').value.trim();
                const url = document.getElementById('marker-embed-url').value.trim();
                if (!title || !url) { isValid = false; showToast('請填寫標題和網址/內嵌碼！', true); } 
                else { Object.assign(newMarkerData, { title, url }); }
            }
            
            if (!isValid) return; 

            if (editingMarkerId) {
                const updateObject = { id: editingMarkerId, data: newMarkerData };
                if (newMarkerData.title) updateObject.tooltip = { content: newMarkerData.title };
                else if (newMarkerData.label) updateObject.tooltip = { content: `前往: ${scenes.find(s=>s.id === newMarkerData.targetSceneId)?.name || ''}`};
                else if (markerType === 'quiz') updateObject.tooltip = { content: '回答問題' };
                markersPlugin.updateMarker(updateObject);
                showToast('標記已更新');
            } else {
                const baseConfig = { id: `marker-${Date.now()}`, longitude: tempMarkerData.longitude, latitude: tempMarkerData.latitude, data: newMarkerData };
                let newMarkerConfig;
                if (markerType === 'info') newMarkerConfig = { ...baseConfig, html: `<div class="w-8 h-8 bg-fuchsia-500 border-2 border-black rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md">+</div>`, width: 32, height: 32, anchor: 'center center', tooltip: { content: newMarkerData.title }};
                else if (markerType === 'link') {
                    newMarkerConfig = { 
                        ...baseConfig, 
                        html: `<div class="link-marker-content">
                                    <div class="link-marker-label">${newMarkerData.label}</div>
                                    <svg viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="45" fill="#FDE047" stroke="#831843" stroke-width="4" />
                                        <path d="M 50 70 L 50 30 M 35 45 L 50 30 L 65 45" stroke="#831843" stroke-width="10" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>`,
                        className: 'link-marker', 
                        width: 70, 
                        height: 70, 
                        anchor: 'bottom center', 
                        tooltip: { content: `前往: ${scenes.find(s=>s.id === newMarkerData.targetSceneId)?.name || ''}`}
                    };
                }
                else if (markerType === 'quiz') newMarkerConfig = { ...baseConfig, html: `<div class="w-8 h-8 bg-purple-500 border-2 border-black rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md">?</div>`, width: 32, height: 32, anchor: 'center center', tooltip: { content: '回答問題' }};
                else if (markerType === 'embed') newMarkerConfig = { ...baseConfig, html: `<div class="w-8 h-8 bg-teal-500 border-2 border-black rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></></div>`, width: 32, height: 32, anchor: 'center center', tooltip: { content: newMarkerData.title }};
                if (newMarkerConfig) markersPlugin.addMarker(newMarkerConfig);
            }
            hideMarkerModal();
            saveState();
        }

        function handleMarkerSelect(e, marker) {
            if (isMovingMarker) return; 
            const markerData = marker.config.data;
            if (!markerData) return;

            if (!isInEditMode) {
                if (markerData.type === 'link') { loadScene(markerData.targetSceneId); return; }
                if (markerData.type === 'quiz') { showQuiz(markerData); return; }
                if (markerData.type === 'embed') { showEmbed(markerData); return; }
            }

            const contentPanel = document.getElementById('content-panel');
            const contentPanelBody = document.getElementById('content-panel-body');
            let contentHTML = '';

            switch (markerData.type) {
                case 'info':
                    contentHTML += `<h3 class="font-bold text-2xl mb-2 text-fuchsia-600">${markerData.title || '資訊'}</h3>`;
                    if (markerData.audioUrl) {
                        contentHTML += `<audio controls src="${markerData.audioUrl}" class="w-full mt-2"></audio>`;
                    }
                    if (markerData.imageUrl) contentHTML += `<img src="${markerData.imageUrl}" alt="Marker Image" onerror="this.src='https://placehold.co/400x300/ff0000/FFFFFF?text=Image+Error';">`;
                    if (markerData.content) contentHTML += `<p class="mt-4 whitespace-pre-wrap">${markerData.content}</p>`;
                    if (markerData.linkUrl) contentHTML += `<a href="${markerData.linkUrl}" target="_blank" class="pop-button mt-4 w-full text-center block bg-sky-400 hover:bg-sky-500">${markerData.linkText || '了解更多'}</a>`;
                    break;
                case 'link':
                    contentHTML += `<h3 class="font-bold text-2xl mb-2 text-fuchsia-600">場景連結</h3><p>此標記會將使用者帶往「${scenes.find(s => s.id === markerData.targetSceneId)?.name || '未知場景'}」。</p>`;
                    break;
                case 'quiz':
                    contentHTML += `<h3 class="font-bold text-2xl mb-2 text-fuchsia-600">測驗挑戰</h3><p class="whitespace-pre-wrap"><b>題目：</b>${markerData.question}</p>`;
                    break;
                case 'embed':
                    contentHTML += `<h3 class="font-bold text-2xl mb-2 text-fuchsia-600">內嵌內容</h3><p><b>標題：</b>${markerData.title}</p>`;
                    break;
            }

            const buttonsHTML = `<div class="mt-6 border-t-2 border-rose-300 pt-4 flex flex-col gap-3">
                <h4 class="font-bold text-lg text-center">管理標記</h4>
                <div class="flex gap-3">
                    <button id="edit-marker-btn" data-marker-id="${marker.id}" class="pop-button flex-1 bg-sky-400">編輯</button>
                    <button id="move-marker-btn" data-marker-id="${marker.id}" class="pop-button flex-1 bg-amber-400">移動</button>
                    <button id="delete-marker-btn" data-marker-id="${marker.id}" class="pop-button flex-1 bg-red-500 text-white">刪除</button>
                </div>
            </div>`;

            contentPanelBody.innerHTML = contentHTML + (isInEditMode ? buttonsHTML : '');
            contentPanel.classList.remove('hidden');
        }
        
        function showEmbed(embedData) {
            document.getElementById('embed-title').textContent = embedData.title;
            let content = embedData.url.trim();
            if (!content.startsWith('<iframe')) {
                content = `<iframe src="${content}" class="w-full h-full border-0" allowfullscreen></iframe>`;
            }
            document.getElementById('embed-content').innerHTML = content;
            document.getElementById('embed-display-modal').classList.remove('hidden');
        }

        function showQuiz(quizData) {
            currentQuizData = quizData;
            const quizDisplayModal = document.getElementById('quiz-display-modal');
            const quizQuestion = document.getElementById('quiz-question');
            const quizAnswers = document.getElementById('quiz-answers');
            const quizActionButtons = document.getElementById('quiz-action-buttons');
            const quizHintContainer = document.getElementById('quiz-hint-container');
            
            quizQuestion.textContent = quizData.question;
            quizAnswers.innerHTML = ''; 
            quizActionButtons.innerHTML = '';
            quizHintContainer.classList.add('hidden');

            switch (quizData.quizType) {
                case 'mc':
                    ['a', 'b', 'c', 'd'].forEach(opt => {
                        if (quizData.answers[opt]) {
                            const answerBtn = document.createElement('button');
                            answerBtn.className = 'pop-button bg-sky-400 hover:bg-sky-500 text-black p-4 text-left w-full';
                            answerBtn.innerHTML = `<span class="font-bold mr-2">${opt.toUpperCase()}.</span> ${quizData.answers[opt]}`;
                            answerBtn.onclick = () => checkAnswer(opt === quizData.correctAnswer);
                            quizAnswers.appendChild(answerBtn);
                        }
                    });
                    break;
                case 'sort':
                    const items = [...quizData.correctOrder].sort(() => Math.random() - 0.5);
                    items.forEach(itemText => { const itemEl = document.createElement('div'); itemEl.textContent = itemText; itemEl.className = 'sortable-item pop-button bg-white p-3'; itemEl.draggable = true; quizAnswers.appendChild(itemEl); });
                    makeSortable(quizAnswers);
                    const checkSortBtn = document.createElement('button'); checkSortBtn.textContent = '確定答案'; checkSortBtn.className = 'pop-button bg-lime-500 py-2 px-6'; checkSortBtn.onclick = checkSortAnswer;
                    quizActionButtons.appendChild(checkSortBtn);
                    break;
                case 'fill':
                    const questionHtml = quizData.question.replace(/___/g, '<input type="text" class="fill-answer-input mx-2 p-1 border-2 border-black w-32 bg-white rounded-md">');
                    const questionP = document.createElement('p'); questionP.innerHTML = questionHtml; questionP.className = 'text-center text-lg';
                    quizAnswers.appendChild(questionP);
                    const checkFillBtn = document.createElement('button'); checkFillBtn.textContent = '確定答案'; checkFillBtn.className = 'pop-button bg-lime-500 py-2 px-6'; checkFillBtn.onclick = checkFillAnswer;
                    quizActionButtons.appendChild(checkFillBtn);
                    break;
            }
            const closeBtn = document.createElement('button'); closeBtn.textContent = '關閉'; closeBtn.className = 'pop-button bg-gray-300 py-2 px-6'; closeBtn.onclick = () => quizDisplayModal.classList.add('hidden');
            quizActionButtons.appendChild(closeBtn);
            quizDisplayModal.classList.remove('hidden');
        }

        function checkAnswer(isCorrect) {
            const quizDisplayModal = document.getElementById('quiz-display-modal');
            if (isCorrect) { 
                showToast('答對了！'); 
                quizDisplayModal.classList.add('hidden'); 
                if (currentQuizData.targetSceneId) {
                    setTimeout(() => loadScene(currentQuizData.targetSceneId), 500); 
                }
            } else { 
                showToast('答錯了，再試一次！', true); 
                if (currentQuizData.hint) { 
                    document.getElementById('quiz-hint-text').textContent = `提示：${currentQuizData.hint}`; 
                    document.getElementById('quiz-hint-container').classList.remove('hidden'); 
                } 
            }
        }
        function checkSortAnswer() { const currentOrder = [...document.getElementById('quiz-answers').querySelectorAll('.sortable-item')].map(item => item.textContent); checkAnswer(JSON.stringify(currentOrder) === JSON.stringify(currentQuizData.correctOrder)); }
        function checkFillAnswer() { const userInput = document.querySelector('.fill-answer-input').value.trim(); const correctAnswers = currentQuizData.answers.map(ans => ans.toLowerCase()); checkAnswer(correctAnswers.includes(userInput.toLowerCase())); }
        function makeSortable(container) { let dI = null; container.addEventListener('dragstart', e => { dI = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }); container.addEventListener('dragend', e => e.target.classList.remove('dragging')); container.addEventListener('dragover', e => { e.preventDefault(); const aE = getDragAfterElement(container, e.clientY); if (aE == null) container.appendChild(dI); else container.insertBefore(dI, aE); }); }
        function getDragAfterElement(container, y) { const dE = [...container.querySelectorAll('.sortable-item:not(.dragging)')]; return dE.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        
        function showToast(message, isError = false) { 
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            clearTimeout(toastTimeout); 
            toastMessage.textContent = message; 
            toastNotification.className = `fixed top-5 left-1/2 -translate-x-1/2 text-white py-3 px-6 border-2 shadow-lg rounded-full ${isError ? 'bg-red-500 border-red-800' : 'bg-rose-500 border-rose-800'} show`; 
            toastTimeout = setTimeout(() => toastNotification.classList.remove('show'), 3000); 
        }

        function saveState() {
            if (scenes.length === 0) {
                localStorage.removeItem('tourData');
                return;
            };
            const currentScene = scenes.find(s => s.id === currentSceneId);
            if(currentScene && markersPlugin) {
                currentScene.markers = markersPlugin.getMarkers().map(m => m.config);
            }
            
            const scenesToStore = JSON.parse(JSON.stringify(scenes));
            scenesToStore.forEach(scene => {
                if (scene.url && (scene.url.startsWith('blob:') || scene.url.startsWith('data:'))) {
                    scene.url = scene.url.startsWith('https://') ? scene.url : ''; 
                }
                if(scene.markers) {
                    scene.markers.forEach(markerConfig => {
                        if (markerConfig.data && markerConfig.data.audioUrl) {
                            delete markerConfig.data.audioUrl;
                        }
                    });
                }
            });

            try {
                localStorage.setItem('tourData', JSON.stringify(scenesToStore));
            } catch (e) {
                console.error("Failed to save state:", e);
                if (e.name === 'QuotaExceededError') {
                    showToast('本機儲存空間已滿，無法儲存進度！請嘗試減少場景或標記數量。', true);
                }
            }
        }

        function loadState() {
            const savedData = localStorage.getItem('tourData');
            if (savedData) {
                try {
                    let parsedScenes = JSON.parse(savedData);
                    parsedScenes = parsedScenes.filter(scene => scene.url);

                    if(parsedScenes.length > 0) {
                       initializeTour(parsedScenes, "已載入您上次的編輯進度！(本機圖片與音訊需重新上傳)");
                       return true;
                    }
                } catch(e) {
                    console.error("無法解析儲存的資料:", e);
                    localStorage.removeItem('tourData'); 
                }
            }
            return false;
        }

        function initializeTour(loadedScenes, message, startInEditMode = false) {
            if (!Array.isArray(loadedScenes) || loadedScenes.length === 0) {
                showToast('載入的導覽資料無效或為空。', true);
                return;
            }
            scenes = loadedScenes;
            loadScene(scenes[0].id);
            document.getElementById('upload-container').classList.add('hidden');
            const controlPanel = document.getElementById('control-panel');
            controlPanel.classList.remove('hidden');
            controlPanel.classList.add('flex');
            renderSceneList();
            if (message) showToast(message);

            if (startInEditMode) {
                toggleEditMode(true);
            }
        }

        const blobToDataURL = (blob) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
        
        function cacheLibraries() {
            console.log('正在從內嵌資源準備程式庫...');
            try {
                cachedLibs = {
                    tailwindJs: document.getElementById('lib-tailwind-js').textContent,
                    threeJs: document.getElementById('lib-three-js').textContent,
                    uEventJs: document.getElementById('lib-uevent-js').textContent,
                    psvCss: document.getElementById('lib-psv-css').textContent,
                    psvJs: document.getElementById('lib-psv-js').textContent,
                    markersCss: document.getElementById('lib-markers-css').textContent,
                    markersJs: document.getElementById('lib-markers-js').textContent
                };
                for (const key in cachedLibs) {
                    if (!cachedLibs[key] || cachedLibs[key].trim() === '') {
                        throw new Error(`內嵌程式庫 '${key}' 是空的或不存在。`);
                    }
                }
                console.log('所有程式庫已從內嵌資源載入完畢。');
            } catch (error) {
                console.error('從內嵌資源載入程式庫時發生錯誤:', error);
                cachedLibs = null;
                showToast(`資源載入失敗，匯出功能將無法使用。`, true);
            }
        }

        // =============================================
        // ✨ NEW EXPORT FUNCTION (ZIP PACKAGE)
        // =============================================
        async function exportTour() {
            if (!cachedLibs || typeof JSZip === 'undefined') {
                showToast('必要資源 (JSZip) 載入失敗，無法匯出。', true);
                return;
            }
            showToast('正在建立您的導覽壓縮檔...', false);

            try {
                const zip = new JSZip();
                const libsFolder = zip.folder('libs');
                const assetsFolder = zip.folder('assets');

                // Step 1: Add libraries to zip
                libsFolder.file('photo-sphere-viewer.min.css', cachedLibs.psvCss);
                libsFolder.file('markers.min.css', cachedLibs.markersCss);
                libsFolder.file('tailwind.js', cachedLibs.tailwindJs);
                libsFolder.file('three.min.js', cachedLibs.threeJs);
                libsFolder.file('uevent.min.js', cachedLibs.uEventJs);
                libsFolder.file('photo-sphere-viewer.min.js', cachedLibs.psvJs);
                libsFolder.file('markers.min.js', cachedLibs.markersJs);
                
                // Step 2: Finalize scene data and process assets
                const currentScene = scenes.find(s => s.id === currentSceneId);
                if (currentScene && markersPlugin) {
                    currentScene.markers = markersPlugin.getMarkers().map(m => m.config);
                }

                const scenesForExport = JSON.parse(JSON.stringify(scenes));
                showToast('正在處理媒體檔案...', false);

                const assetPromises = scenesForExport.flatMap((scene, sceneIndex) => {
                    const scenePromises = [];
                    // Process scene panorama
                    if (scene.url && scene.url.startsWith('blob:')) {
                        const extension = scene.name.split('.').pop() || 'jpg';
                        const fileName = `scene-${sceneIndex}.${extension}`;
                        scenePromises.push(
                            fetch(scene.url).then(res => res.blob()).then(blob => {
                                assetsFolder.file(fileName, blob);
                                scene.url = `assets/${fileName}`;
                            })
                        );
                    }
                    // Process markers media
                    if (scene.markers) {
                        scene.markers.forEach((markerConfig, markerIndex) => {
                            if (markerConfig.data && markerConfig.data.audioUrl && markerConfig.data.audioUrl.startsWith('blob:')) {
                                const fileName = `audio-${sceneIndex}-${markerIndex}.webm`;
                                scenePromises.push(
                                    fetch(markerConfig.data.audioUrl).then(res => res.blob()).then(blob => {
                                        assetsFolder.file(fileName, blob);
                                        markerConfig.data.audioUrl = `assets/${fileName}`;
                                    })
                                );
                            }
                        });
                    }
                    return scenePromises;
                });
                
                await Promise.all(assetPromises);

                if (!scenesForExport.length) {
                    showToast('沒有可匯出的內容！', true); return;
                }
                
                // Step 3: Create tour-data.js
                zip.file('tour-data.js', `const tourData = ${JSON.stringify(scenesForExport, null, 2)};`);

                // Step 4: Create main application logic file (app.js)
                const appLogicString = `
                    document.addEventListener('DOMContentLoaded', () => {
                        if (typeof tourData === 'undefined' || !tourData.length) {
                             document.body.innerHTML = '<h1>錯誤：找不到導覽資料 (tour-data.js)。</h1>'; return;
                        }
                        const scenes = tourData;
                        let viewer, markersPlugin, currentSceneId, sceneHistory = [], currentQuizData, toastTimeout;
                        
                        function showToast(message, isError = false) {
                            const toast = document.getElementById('toast-notification'), msg = document.getElementById('toast-message');
                            if (!toast) return;
                            clearTimeout(toastTimeout);
                            msg.textContent = message;
                            toast.className = \`fixed top-5 left-1/2 -translate-x-1/2 text-white py-3 px-6 border-2 shadow-lg rounded-full \${isError ? 'bg-red-500 border-red-800' : 'bg-rose-500 border-rose-800'} show\`;
                            toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
                        }
                        
                        const loadScene = (sceneId, isBack = false) => {
                            const scene = scenes.find(s => s.id === sceneId);
                            if (!scene) return;
                            if (!isBack && currentSceneId) sceneHistory.push(currentSceneId);
                            document.getElementById('back-btn').classList.toggle('hidden', sceneHistory.length === 0);
                            if (viewer) {
                                viewer.setPanorama(scene.url, { transition: true, showLoader: true }).then(() => {
                                    viewer.navbar.setCaption(\`<b class="font-bold" style="color: black; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">\${scene.name}</b>\`);
                                    markersPlugin.setMarkers(scene.markers || []);
                                });
                            } else {
                                viewer = new PhotoSphereViewer.Viewer({
                                    container: document.getElementById('viewer'), panorama: scene.url,
                                    caption: \`<b class="font-bold" style="color: black; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">\${scene.name}</b>\`,
                                    navbar: ['zoom', 'caption', 'fullscreen'],
                                    plugins: [ [PhotoSphereViewer.MarkersPlugin, { markers: scene.markers || [] }] ]
                                });
                                markersPlugin = viewer.getPlugin(PhotoSphereViewer.MarkersPlugin);
                                markersPlugin.on('select-marker', (e, marker) => handleMarkerSelect(marker));
                            }
                            currentSceneId = sceneId;
                        };
                        const handleMarkerSelect = (marker) => {
                            const data = marker.config.data;
                            if (!data) return;
                            if (data.type === 'link') loadScene(data.targetSceneId);
                            else if (data.type === 'quiz') showQuiz(data);
                            else if (data.type === 'embed') showEmbed(data);
                            else if (data.type === 'info') {
                                const contentPanelBody = document.getElementById('content-panel-body');
                                let contentHTML = \`<h3 class="text-4xl font-bold mb-4 text-rose-600">\${data.title || '資訊'}</h3>\`;
                                if (data.audioUrl) contentHTML += \`<audio controls src="\${data.audioUrl}" class="w-full mt-2"></audio>\`;
                                if (data.imageUrl) contentHTML += \`<img src="\${data.imageUrl}" alt="Image" class="w-full border-2 border-pink-300 rounded-lg mt-2 cursor-pointer" onerror="this.style.display='none'">\`;
                                if (data.content) contentHTML += \`<p class="mt-4 whitespace-pre-wrap">\${data.content}</p>\`;
                                if (data.linkUrl) contentHTML += \`<a href="\${data.linkUrl}" target="_blank" rel="noopener noreferrer" class="pop-button mt-4 w-full text-center block bg-rose-400 hover:bg-rose-500 text-white">\${data.linkText || '了解更多'}</a>\`;
                                contentPanelBody.innerHTML = contentHTML;
                                document.getElementById('content-panel').classList.remove('hidden');
                            }
                        };
                        const showEmbed = (embedData) => {
                            document.getElementById('embed-title').textContent = embedData.title;
                            let content = embedData.url.trim();
                            if (!content.startsWith('<iframe')) content = \`<iframe src="\${content}" class="w-full h-full border-0" allowfullscreen></iframe>\`;
                            document.getElementById('embed-content').innerHTML = content;
                            document.getElementById('embed-display-modal').classList.remove('hidden');
                        };
                        const showQuiz = (quizData) => {
                            currentQuizData = quizData;
                            const modal = document.getElementById('quiz-display-modal'), question = document.getElementById('quiz-question'), answers = document.getElementById('quiz-answers'), actions = document.getElementById('quiz-action-buttons'), hint = document.getElementById('quiz-hint-container');
                            question.textContent = quizData.question;
                            answers.innerHTML = ''; actions.innerHTML = ''; hint.classList.add('hidden');
                            switch(quizData.quizType) {
                                case 'mc':
                                    ['a', 'b', 'c', 'd'].forEach(opt => {
                                        if(quizData.answers[opt]) {
                                            const btn = document.createElement('button');
                                            btn.className = 'pop-button bg-sky-300 hover:bg-sky-400 text-sky-800 p-4 text-left w-full text-lg';
                                            btn.innerHTML = \`<span class="font-bold mr-2">\${opt.toUpperCase()}.</span> \${quizData.answers[opt]}\`;
                                            btn.onclick = () => checkAnswer(opt === quizData.correctAnswer);
                                            answers.appendChild(btn);
                                        }
                                    });
                                    break;
                                case 'sort':
                                    const items = [...quizData.correctOrder].sort(() => Math.random() - 0.5);
                                    items.forEach(itemText => { const itemEl = document.createElement('div'); itemEl.textContent = itemText; itemEl.className = 'sortable-item pop-button bg-white p-3 text-lg'; itemEl.draggable = true; answers.appendChild(itemEl); });
                                    makeSortable(answers);
                                    const checkSortBtn = document.createElement('button'); checkSortBtn.textContent = '確定答案'; checkSortBtn.className = 'pop-button bg-lime-400 py-2 px-6 text-lg'; checkSortBtn.onclick = checkSortAnswer;
                                    actions.appendChild(checkSortBtn);
                                    break;
                                case 'fill':
                                    const questionHtml = quizData.question.replace(/___/g, '<input type="text" class="fill-answer-input mx-2 p-1 border-2 border-rose-400 rounded-lg w-32 bg-white">');
                                    const questionP = document.createElement('p'); questionP.innerHTML = questionHtml; questionP.className = 'text-center text-2xl';
                                    answers.appendChild(questionP);
                                    const checkFillBtn = document.createElement('button'); checkFillBtn.textContent = '確定答案'; checkFillBtn.className = 'pop-button bg-lime-400 py-2 px-6 text-lg'; checkFillBtn.onclick = checkFillAnswer;
                                    actions.appendChild(checkFillBtn);
                                    break;
                            }
                            const closeBtn = document.createElement('button');
                            closeBtn.textContent = '關閉'; closeBtn.className = 'pop-button bg-gray-300 py-2 px-6 text-lg';
                            closeBtn.onclick = () => modal.classList.add('hidden');
                            actions.appendChild(closeBtn);
                            modal.classList.remove('hidden');
                        };
                        const checkAnswer = (isCorrect) => {
                            if (isCorrect) { 
                                showToast('答對了！'); 
                                document.getElementById('quiz-display-modal').classList.add('hidden'); 
                                if(currentQuizData.targetSceneId) setTimeout(() => loadScene(currentQuizData.targetSceneId), 500); 
                            } else { 
                                showToast('答錯了！', true); 
                                if (currentQuizData.hint) { 
                                    document.getElementById('quiz-hint-text').textContent = \`提示：\${currentQuizData.hint}\`; 
                                    document.getElementById('quiz-hint-container').classList.remove('hidden'); 
                                } 
                            }
                        };
                        function checkSortAnswer() { const currentOrder = [...document.getElementById('quiz-answers').querySelectorAll('.sortable-item')].map(item => item.textContent); checkAnswer(JSON.stringify(currentOrder) === JSON.stringify(currentQuizData.correctOrder)); }
                        function checkFillAnswer() { const userInput = document.querySelector('.fill-answer-input').value.trim(); const correctAnswers = currentQuizData.answers.map(ans => ans.toLowerCase()); checkAnswer(correctAnswers.includes(userInput.toLowerCase())); }
                        function makeSortable(container) { let dI = null; container.addEventListener('dragstart', e => { dI = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }); container.addEventListener('dragend', e => e.target.classList.remove('dragging')); container.addEventListener('dragover', e => { e.preventDefault(); const aE = getDragAfterElement(container, e.clientY); if (aE == null) container.appendChild(dI); else container.insertBefore(dI, aE); }); }
                        function getDragAfterElement(container, y) { const dE = [...container.querySelectorAll('.sortable-item:not(.dragging)')]; return dE.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }

                        loadScene(scenes[0].id);
                        document.getElementById('close-content-btn').addEventListener('click', () => document.getElementById('content-panel').classList.add('hidden'));
                        document.getElementById('back-btn').addEventListener('click', () => { if (sceneHistory.length > 0) loadScene(sceneHistory.pop(), true); });
                        document.getElementById('close-embed-btn').addEventListener('click', () => { document.getElementById('embed-display-modal').classList.add('hidden'); document.getElementById('embed-content').innerHTML = ''; });
                        const lightbox = document.getElementById('image-lightbox'), lightboxImage = document.getElementById('lightbox-image');
                        document.getElementById('content-panel-body').addEventListener('click', (e) => {
                            if (e.target.tagName === 'IMG') { lightboxImage.src = e.target.src; lightbox.classList.remove('hidden'); }
                        });
                        const closeLightbox = () => { lightbox.classList.add('hidden'); lightboxImage.src = ''; };
                        document.getElementById('close-lightbox-btn').addEventListener('click', closeLightbox);
                        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
                    });
                `;
                zip.file('app.js', appLogicString);

                // Step 5: Create the main index.html file
                const exportHtmlTemplate = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${scenesForExport[0].name || '360° 互動導覽'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="libs/photo-sphere-viewer.min.css">
    <link rel="stylesheet" href="libs/markers.min.css">
    <style>${document.querySelector('style').innerHTML}<\/style>
    <script src="libs/tailwind.js"><\/script>
</head>
<body class="text-rose-900">
    <div id="viewer"></div>
    <button id="back-btn" class="hidden pop-button bg-yellow-200 !rounded-full px-4 py-2 text-2xl">← 返回</button>
    <div id="content-panel" class="panel hidden fixed top-0 right-0 h-full w-full max-w-sm bg-rose-50 border-l-2 border-rose-300 z-30 p-6 shadow-2xl">
        <button id="close-content-btn" class="absolute top-4 right-4 text-rose-400 hover:text-rose-600 text-5xl font-black">×</button>
        <div id="content-panel-body" class="text-rose-800 mt-16 overflow-y-auto h-[95%] text-lg"></div>
    </div>
    <div id="quiz-display-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-pink-100 rounded-2xl border-2 border-rose-400 shadow-xl p-8 w-full max-w-lg">
            <h3 id="quiz-question" class="text-4xl font-bold mb-8 text-center text-rose-600"></h3>
            <div id="quiz-answers" class="space-y-3"></div>
            <div id="quiz-hint-container" class="hidden mt-4 p-4 bg-red-100 border-2 border-red-400 text-red-800 font-semibold rounded-lg text-lg"><p id="quiz-hint-text"></p></div>
            <div id="quiz-action-buttons" class="mt-8 flex justify-center gap-4"></div>
        </div>
    </div>
    <div id="embed-display-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 md:p-8">
        <div class="bg-pink-100 rounded-2xl border-2 border-rose-400 shadow-xl p-2 w-full max-w-4xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-2 border-b-2 border-rose-200 flex-shrink-0">
                <h3 id="embed-title" class="text-2xl font-bold text-rose-600 px-2"></h3>
                <button id="close-embed-btn" class="text-rose-400 hover:text-rose-600 text-5xl font-black">×</button>
            </div>
            <div id="embed-content" class="flex-grow bg-white overflow-hidden rounded-b-xl"></div>
        </div>
    </div>
    <div id="toast-notification" class="fixed top-5 left-1/2 -translate-x-1/2 text-white py-3 px-6 border-2 shadow-lg rounded-full" style="transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; transform: translateY(-120%); opacity: 0; z-index: 60;">
        <p id="toast-message" class="font-bold text-lg"></p>
    </div>
    <div id="image-lightbox" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 cursor-pointer">
        <button id="close-lightbox-btn" class="absolute top-4 right-4 text-white text-5xl font-black">&times;</button>
        <img id="lightbox-image" src="" alt="放大的圖片" class="max-w-full max-h-full object-contain">
    </div>

    <script src="libs/three.min.js"><\/script>
    <script src="libs/uevent.min.js"><\/script>
    <script src="libs/photo-sphere-viewer.min.js"><\/script>
    <script src="libs/markers.min.js"><\/script>
    <script src="tour-data.js"><\/script>
    <script src="app.js"><\/script>
</body>
</html>`;
                zip.file('index.html', exportHtmlTemplate);
                
                // Step 6: Generate and download the zip file
                showToast('正在產生壓縮檔...');
                zip.generateAsync({ type: 'blob' }).then(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `tour-專案.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    showToast('導覽壓縮檔已成功匯出！');
                });

            } catch (error) {
                console.error('打包導覽時發生錯誤:', error);
                showToast(`打包導覽失敗: ${error.message}`, true);
            }
        }


        function handleTourImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('正在讀取專案檔案...');
            const reader = new FileReader();

            reader.onload = (e) => {
                const htmlContent = e.target.result;
                 const match = htmlContent.match(/<script id="tour-data"[^>]*>([\s\S]*?)<\/script>/);

                if (match && match[1]) {
                    try {
                        const parsedScenes = JSON.parse(match[1]);
                        initializeTour(parsedScenes, '專案已成功匯入！', true);
                    } catch (error) {
                        showToast('專案檔案格式錯誤，無法解析場景資料。', true);
                        console.error("Import Error: ", error);
                    }
                } else {
                    showToast('找不到有效的導覽資料，請確認檔案是否為此平台匯出的檔案。', true);
                }
            };
            reader.onerror = () => showToast('讀取檔案時發生錯誤。', true);
            reader.readAsText(file);
            event.target.value = '';
        }

        async function startRecording() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showToast('您的瀏覽器不支援錄音功能。', true);
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                document.getElementById('record-audio-btn').classList.add('hidden');
                document.getElementById('stop-record-btn').classList.remove('hidden');
                document.getElementById('record-timer').textContent = '00:00';
                showToast('錄音已開始...');

                let startTime = Date.now();
                recordingInterval = setInterval(() => {
                    const seconds = Math.floor((Date.now() - startTime) / 1000);
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    document.getElementById('record-timer').textContent = `${mins}:${secs}`;
                }, 1000);

                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (currentAudioBlobUrl) {
                        URL.revokeObjectURL(currentAudioBlobUrl);
                    }
                    currentAudioBlobUrl = URL.createObjectURL(audioBlob);
                    const audioPreview = document.getElementById('marker-info-audio-preview');
                    audioPreview.src = currentAudioBlobUrl;

                    document.getElementById('audio-preview-container').classList.remove('hidden');
                    document.getElementById('audio-preview-container').classList.add('flex');
                    document.getElementById('audio-controls').classList.add('hidden');

                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
            } catch (err) {
                console.error("無法取得麥克風權限:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showToast('您已封鎖麥克風權限，請至瀏覽器設定中重新開啟。', true);
                } else {
                    showToast('無法取得麥克風權限！', true);
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('record-audio-btn').classList.remove('hidden');
                document.getElementById('stop-record-btn').classList.add('hidden');
                 document.getElementById('record-timer').textContent = '';
                showToast('錄音已結束。');
            }
        }

        function resetAudioState() {
             if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            const audioPreview = document.getElementById('marker-info-audio-preview');
            const audioUpload = document.getElementById('marker-info-audio-upload');
            if (currentAudioBlobUrl) {
                URL.revokeObjectURL(currentAudioBlobUrl);
                currentAudioBlobUrl = null;
            }
            audioPreview.removeAttribute('src');
            audioUpload.value = '';

            document.getElementById('audio-preview-container').classList.add('hidden');
            document.getElementById('audio-controls').classList.remove('hidden');
            document.getElementById('record-audio-btn').classList.remove('hidden');
            document.getElementById('stop-record-btn').classList.add('hidden');
            document.getElementById('record-timer').textContent = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('image-upload');
            const addSceneInput = document.getElementById('add-scene-upload');
            const tourImportInput = document.getElementById('tour-import');
            const backBtn = document.getElementById('back-btn');
            const exportTourBtn = document.getElementById('export-tour-btn');
            const clearTourBtn = document.getElementById('clear-tour-btn');
            const tabUpload = document.getElementById('tab-upload');
            const tabGsv = document.getElementById('tab-gsv');
            const tabImport = document.getElementById('tab-import');
            const initialImportGsvBtn = document.getElementById('initial-import-gsv-btn');
            const importGsvBtn = document.getElementById('import-gsv-btn');
            const gsvAccordionToggle = document.getElementById('gsv-accordion-toggle');
            const contentPanel = document.getElementById('content-panel');
            const sceneListPanel = document.getElementById('scene-list-panel');
            const quizTypeSelect = document.getElementById('quiz-type-select');
            const embedDisplayModal = document.getElementById('embed-display-modal');
            const contentPanelBody = document.getElementById('content-panel-body');
            const initialGsvUrlInput = document.getElementById('initial-gsv-url');
            const gsvUrlInput = document.getElementById('gsv-url');
            const gsvApiKeyInput = document.getElementById('gsv-api-key');
            const initialGsvApiKeyInput = document.getElementById('initial-gsv-api-key');
            const scenesContainer = document.getElementById('scenes-container');
            const recordAudioBtn = document.getElementById('record-audio-btn');
            const stopRecordBtn = document.getElementById('stop-record-btn');
            const clearAudioBtn = document.getElementById('clear-audio-btn');
            const audioUploadInput = document.getElementById('marker-info-audio-upload');
            const toggleHelpBtn = document.getElementById('toggle-help-btn');
            const helpContent = document.getElementById('help-content');
            const helpArrow = document.getElementById('help-arrow');
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const closeLightboxBtn = document.getElementById('close-lightbox-btn');
            const requestMicBtn = document.getElementById('request-mic-btn');
            
            cacheLibraries();

            if (!loadState()) {
              document.getElementById('upload-container').classList.remove('hidden');
              if (navigator.mediaDevices && navigator.permissions) {
                  checkAndSetMicPermission();
              }
            } 

            fileInput.addEventListener('change', (event) => { const files = handleFileUpload(event.target.files); addNewScenes(files); event.target.value = ''; });
            addSceneInput.addEventListener('change', (event) => { const files = handleFileUpload(event.target.files); addNewScenes(files); event.target.value = ''; });
            tourImportInput.addEventListener('change', handleTourImport);

            backBtn.addEventListener('click', () => { 
                if (sceneHistory.length > 0) loadScene(sceneHistory.pop(), true); 
            });
            exportTourBtn.addEventListener('click', exportTour);
            
            clearTourBtn.addEventListener('click', () => {
                if (clearTourBtn.dataset.confirming) {
                    scenes.forEach(scene => {
                        if (scene.url && scene.url.startsWith('blob:')) {
                            URL.revokeObjectURL(scene.url);
                        }
                    });
                    localStorage.removeItem('tourData');
                    showToast('導覽已重設！');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    clearTourBtn.textContent = '確定要重設嗎？將會清除所有進度！';
                    clearTourBtn.dataset.confirming = 'true';
                    setTimeout(() => {
                        clearTourBtn.textContent = '重設導覽';
                        delete clearTourBtn.dataset.confirming;
                    }, 3000);
                }
            });

            tabUpload.addEventListener('click', () => { 
                tabUpload.classList.add('active'); 
                tabGsv.classList.remove('active'); 
                tabImport.classList.remove('active');
                document.getElementById('upload-panel').classList.remove('hidden'); 
                document.getElementById('gsv-panel').classList.add('hidden');
                document.getElementById('import-panel').classList.add('hidden');
            });
            tabGsv.addEventListener('click', () => { 
                tabGsv.classList.add('active'); 
                tabUpload.classList.remove('active'); 
                tabImport.classList.remove('active');
                document.getElementById('gsv-panel').classList.remove('hidden'); 
                document.getElementById('upload-panel').classList.add('hidden'); 
                document.getElementById('import-panel').classList.add('hidden');
            });
             tabImport.addEventListener('click', () => {
                tabUpload.classList.remove('active');
                tabGsv.classList.remove('active');
                tabImport.classList.add('active');
                document.getElementById('upload-panel').classList.add('hidden');
                document.getElementById('gsv-panel').classList.add('hidden');
                document.getElementById('import-panel').classList.remove('hidden');
            });
            
            initialImportGsvBtn.addEventListener('click', () => handleGsvImport(initialGsvUrlInput, initialGsvApiKeyInput));
            importGsvBtn.addEventListener('click', () => handleGsvImport(gsvUrlInput, gsvApiKeyInput));
            gsvAccordionToggle.addEventListener('click', () => { document.getElementById('gsv-accordion-content').classList.toggle('hidden'); document.getElementById('gsv-accordion-icon').classList.toggle('rotate-180'); });
            
            gsvApiKeyInput.addEventListener('input', (e) => { initialGsvApiKeyInput.value = e.target.value; });
            initialGsvApiKeyInput.addEventListener('input', (e) => { gsvApiKeyInput.value = e.target.value; });
            
            document.getElementById('edit-mode-btn').addEventListener('click', () => toggleEditMode(true));
            document.getElementById('exit-edit-mode-btn').addEventListener('click', () => toggleEditMode(false));
            document.getElementById('add-info-marker-btn').addEventListener('click', () => prepareAddMarker('info'));
            document.getElementById('add-link-marker-btn').addEventListener('click', () => prepareAddMarker('link'));
            document.getElementById('add-quiz-marker-btn').addEventListener('click', () => prepareAddMarker('quiz'));
            document.getElementById('add-embed-marker-btn').addEventListener('click', () => prepareAddMarker('embed'));
            
            document.getElementById('cancel-marker-btn').addEventListener('click', hideMarkerModal);
            document.getElementById('save-marker-btn').addEventListener('click', saveMarker);

            document.getElementById('toggle-scenes-btn').addEventListener('click', () => sceneListPanel.classList.remove('hidden'));
            document.getElementById('close-scenes-btn').addEventListener('click', () => sceneListPanel.classList.add('hidden'));
            document.getElementById('close-content-btn').addEventListener('click', () => contentPanel.classList.add('hidden'));
            document.getElementById('close-embed-btn').addEventListener('click', () => { 
                embedDisplayModal.classList.add('hidden'); 
                document.getElementById('embed-content').innerHTML = ''; 
            });
            
            contentPanelBody.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    lightboxImage.src = e.target.src;
                    lightbox.classList.remove('hidden');
                    return;
                }

                const target = e.target.closest('button'); 
                if (!target) return; 
                const markerId = target.dataset.markerId; 
                if (target.id === 'delete-marker-btn') { 
                    markersPlugin.removeMarker(markerId); 
                    contentPanel.classList.add('hidden'); 
                    showToast('標記已刪除'); 
                    saveState();
                } else if (target.id === 'edit-marker-btn') {
                    startEditMarker(markerId); 
                } else if (target.id === 'move-marker-btn') {
                    startMoveMarker(markerId); 
                }
            });

            const closeLightbox = () => {
                lightbox.classList.add('hidden');
                lightboxImage.src = '';
            };

            closeLightboxBtn.addEventListener('click', closeLightbox);
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isMovingMarker) cancelMoveMarker(); });
            quizTypeSelect.addEventListener('change', (e) => { 
                document.getElementById('quiz-editor-mc').classList.toggle('hidden', e.target.value !== 'mc'); 
                document.getElementById('quiz-editor-sort').classList.toggle('hidden', e.target.value !== 'sort'); 
                document.getElementById('quiz-editor-fill').classList.toggle('hidden', e.target.value !== 'fill'); 
            });

            scenesContainer.addEventListener('dragstart', e => {
                if (e.target.classList.contains('sortable-item')) {
                    draggedSceneId = e.target.dataset.sceneId;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            scenesContainer.addEventListener('dragend', e => {
                if (e.target.classList.contains('sortable-item')) {
                     e.target.classList.remove('dragging');
                }
            });

            scenesContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(scenesContainer, e.clientY);
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                if(afterElement) {
                    afterElement.classList.add('drag-over');
                }
            });
            
            scenesContainer.addEventListener('drop', e => {
                e.preventDefault();
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const afterElement = getDragAfterElement(scenesContainer, e.clientY);
                const draggedIndex = scenes.findIndex(s => s.id === draggedSceneId);
                const draggedScene = scenes.splice(draggedIndex, 1)[0];
                if (afterElement == null) {
                    scenes.push(draggedScene);
                } else {
                    const afterIndex = scenes.findIndex(s => s.id === afterElement.dataset.sceneId);
                    scenes.splice(afterIndex, 0, draggedScene);
                }
                showToast('場景順序已更新！');
                renderSceneList();
                saveState();
            });

            recordAudioBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            clearAudioBtn.addEventListener('click', resetAudioState);
            audioUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    resetAudioState(); 
                    currentAudioBlobUrl = URL.createObjectURL(file);
                    const audioPreview = document.getElementById('marker-info-audio-preview');
                    audioPreview.src = currentAudioBlobUrl;
                    document.getElementById('audio-preview-container').classList.remove('hidden');
                    document.getElementById('audio-preview-container').classList.add('flex');
                    document.getElementById('audio-controls').classList.add('hidden');
                }
            });

            toggleHelpBtn.addEventListener('click', () => {
                helpContent.classList.toggle('hidden');
                helpArrow.classList.toggle('rotate-180');
            });
            
            const handleMicRequest = async () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showToast('您的瀏覽器不支援錄音功能。', true);
                    return;
                }
                showToast('正在請求麥克風權限...');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    console.error('Microphone access request failed:', err);
                    showToast('請求麥克風權限失敗，請檢查您的設定。', true);
                } finally {
                    checkAndSetMicPermission();
                }
            };

            requestMicBtn.addEventListener('click', handleMicRequest);
        });
    </script>
</body>
</html>

