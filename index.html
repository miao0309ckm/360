<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FIX: ä½¿ç”¨ no-referrer éš±è—æœ¬åœ°æª”æ¡ˆè·¯å¾‘ -->
    <meta name="referrer" content="no-referrer">
    <title>VR æ•…äº‹ç·¨è¼¯å™¨ | Pop-VR</title>
    <!-- ä½¿ç”¨ç©©å®šçš„ A-Frame 1.4.0 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <script>
        // è¨»å†Š look-at çµ„ä»¶ï¼Œè®“ç†±é»å§‹çµ‚é¢å‘é¡é ­
        if (typeof AFRAME !== 'undefined') {
            AFRAME.registerComponent('look-at', {
                schema: { type: 'selector' },
                init: function () {},
                tick: function () {
                    if (this.data) { this.el.object3D.lookAt(this.data.object3D.position); }
                }
            });
        }
    </script>

    <style id="main-style">
        :root {
            --c-sky: #87CEEB; --c-grass: #98FB98; --c-candy: #FFB7B2; --c-lemon: #FFFACD;
            --c-paper: #FDFBF7; --c-pencil: #555555;
            --border-solid: 3px solid var(--c-pencil);
            --shadow-soft: 5px 5px 0px rgba(0,0,0,0.15);
            --font-display: 'Comic Sans MS', 'Chalkboard SE', 'Microsoft JhengHei', sans-serif;
            --font-body: 'Verdana', 'Microsoft JhengHei', sans-serif;
        }

        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: var(--font-body); overflow: hidden; background-color: var(--c-sky); }
        a-scene { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 0; }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: var(--font-display); text-align: center;
        }
        #splash-screen h1 { font-size: 48px; color: var(--c-pencil); margin-bottom: 20px; }
        #splash-screen p { font-size: 18px; color: #666; margin-bottom: 30px; }
        .splash-actions { display: flex; gap: 20px; }
        #splash-btn, #import-btn {
            font-size: 20px; padding: 15px 30px; 
            border: 4px solid var(--c-pencil); border-radius: 50px; cursor: pointer;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        #splash-btn { background: var(--c-grass); }
        #import-btn { background: var(--c-lemon); }
        #splash-btn:active, #import-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

        /* Editor UI Grid */
        #editor-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: grid;
            grid-template-columns: 300px 1fr 380px;
            grid-template-rows: auto 1fr;
            z-index: 100; padding: 10px; box-sizing: border-box; gap: 10px;
        }

        .ui-panel {
            pointer-events: auto; background: var(--c-paper); border: var(--border-solid);
            border-radius: 15px 5px 20px 5px; box-shadow: var(--shadow-soft);
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            position: relative; overflow-y: auto; max-height: 100%;
            min-height: 0; /* Fix flex scrolling */
        }

        .ui-header {
            grid-column: 1 / -1; grid-row: 1; background: var(--c-candy);
            display: flex; flex-direction: row; justify-content: space-between; align-items: center;
            border: 4px solid white; transform: rotate(-0.5deg); overflow: visible;
            padding: 10px 20px;
        }

        .ui-sidebar-left { 
            grid-row: 2; grid-column: 1; 
            background: rgba(255, 250, 205, 0.4); 
            backdrop-filter: blur(5px);
            transform: rotate(0.5deg); 
        }
        .ui-sidebar-right { 
            grid-row: 2; grid-column: 3; 
            background: rgba(152, 251, 152, 0.4); 
            backdrop-filter: blur(5px);
            transform: rotate(-0.5deg); 
        }

        h1 { font-family: var(--font-display); margin: 0; color: var(--c-pencil); text-shadow: 2px 2px 0 white; font-size: 24px; line-height: 1.2; }
        .author-info { font-size: 10px; color: #555; font-weight: bold; margin-top: 4px; }
        
        button {
            background: white; border: var(--border-solid); border-radius: 20px;
            font-family: var(--font-display); font-size: 14px; padding: 8px 12px;
            cursor: pointer; transition: all 0.1s; box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            color: var(--c-pencil); white-space: nowrap;
        }
        button:hover { transform: scale(1.05); background: #fff; }
        button:active { transform: scale(0.95); }
        button.primary { background: var(--c-sky); color: white; border: 3px dashed white; box-shadow: 0 0 0 3px var(--c-sky); }
        button.save-btn { background: #98FB98; width: 100%; margin-top: 5px; }
        button.record-btn { background: #FF6B6B; color: white; }
        button.record-btn.recording { animation: pulse 1s infinite; background: red; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        input, select, textarea {
            border: 2px dashed var(--c-pencil); border-radius: 10px; padding: 8px;
            font-family: var(--font-body); background: rgba(255,255,255,0.8);
            width: 100%; box-sizing: border-box; outline: none; margin-bottom: 5px;
        }
        input:focus, textarea:focus { background: white; border-style: solid; }

        .scene-item {
            background: white; border: 1px solid #ddd; padding: 10px; cursor: grab;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; position: relative; border-radius: 5px;
            transition: background 0.2s;
            user-select: none;
        }
        .scene-item:hover { background: #f0f0f0; }
        .scene-item.active { background: var(--c-lemon); border: 2px solid var(--c-pencil); font-weight: bold; }
        .scene-item.dragging { opacity: 0.5; border: 2px dashed #999; }
        .scene-item.over { border-top: 3px solid var(--c-sky); }
        
        .scene-name-span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .delete-scene-btn { 
            cursor: pointer; font-size: 14px; padding: 4px 8px; 
            border-radius: 50%; color: #999; transition: all 0.2s;
            margin-left: 5px; font-weight: bold;
        }
        .delete-scene-btn:hover { color: white; background: #FF6B6B; }

        /* Speech Bubble */
        .speech-bubble {
            position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; max-width: 900px;
            display: none; 
            z-index: 1000;
            overflow: visible; 
            font-family: var(--font-display);
        }

        .speech-content {
            background: white; border: var(--border-solid);
            border-radius: 20px; padding: 25px; 
            max-height: 80vh; overflow-y: auto; 
            box-shadow: 10px 10px 0 rgba(0,0,0,0.2);
        }

        .speech-content iframe { width: 100%; aspect-ratio: 16/9; border: 2px solid #333; border-radius: 10px; margin-top:10px; background: black; }
        
        .info-img-display { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; margin-top: 10px; cursor: zoom-in; border: 2px solid #ddd; }
        .info-video-display { width: 100%; border-radius: 10px; margin-top: 10px; border: 2px solid #ddd; }
        
        #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; cursor: zoom-out;
        }
        #lightbox img { max-width: 90%; max-height: 90%; border: 5px solid white; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* BGM Player */
        #bgm-player {
            position: fixed; bottom: 10px; left: 10px; z-index: 900;
            background: rgba(255, 255, 255, 0.8); border: 2px solid #555;
            border-radius: 30px; padding: 5px 15px; display: none; align-items: center; gap: 10px;
            backdrop-filter: blur(5px); box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            font-family: var(--font-body); font-size: 12px;
        }
        #bgm-status { font-weight: bold; color: #333; }
        #bgm-toggle { cursor: pointer; font-size: 16px; background: none; border: none; padding: 0; box-shadow: none; }
        #bgm-vol { width: 60px; }

        .close-btn {
            position: absolute; top: -15px; right: -15px; background: var(--c-candy); color: white;
            border: 3px solid white; width: 35px; height: 35px; border-radius: 50%;
            text-align: center; line-height: 28px; cursor: pointer; font-weight: bold; font-size: 18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 2000; 
        }

        #file-input, #audio-input, #quiz-audio-input, #info-img-input, #info-video-input, #import-input, #bgm-input { display: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--c-lemon); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--c-pencil); color: white; padding: 10px 20px; border-radius: 20px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        
        .prop-group { border-top: 2px dotted #ccc; padding-top: 10px; margin-top: 10px; }
        .quiz-opt-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .quiz-opt-row input[type="checkbox"] { width: auto; transform: scale(1.2); }
        .quiz-option-btn { width: 100%; margin-bottom: 5px; text-align: left; background: #eee; border: 2px solid transparent; }
        .quiz-option-btn.selected { border: 2px solid var(--c-sky); background: #e0f7fa; }
        .radio-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer; }
        .audio-control-row { display: flex; gap: 5px; margin-top: 5px; }
        .delete-audio-btn { background: #FF6B6B; color: white; padding: 5px 10px; border-radius: 10px; font-size: 12px; margin-left: 5px; }

        /* Scene List */
        #scene-list-container {
            margin-top: 15px;
            border-top: 3px dashed #ccc;
            padding-top: 10px;
            display: flex; flex-direction: column;
        }
        #scene-list-header {
            font-size: 16px; font-weight: bold; margin-bottom: 8px; color: var(--c-pencil);
            background: #fff; padding: 5px 10px; border-radius: 10px; border: 2px solid #eee;
        }
        #scene-list {
            max-height: 250px; 
            overflow-y: auto; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.7);
            padding: 5px;
        }

        /* Custom Modal */
        #sys-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 11000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .sys-modal-box {
            background: white; border: 4px solid var(--c-pencil); border-radius: 20px;
            padding: 25px; width: 320px; text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.3);
            font-family: var(--font-display);
        }
        .sys-modal-title { font-size: 24px; color: var(--c-pencil); margin-bottom: 10px; }
        .sys-modal-msg { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .sys-modal-btns { display: flex; justify-content: center; gap: 15px; }
        .sys-btn { padding: 10px 20px; font-size: 16px; min-width: 80px; }
        .sys-btn-cancel { background: #eee; }
        .sys-btn-ok { background: #FF6B6B; color: white; border-color: #d32f2f; }
        
        /* YouTube Overlay */
        .yt-cover-container {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 10px;
            cursor: pointer;
        }
        .yt-cover-img {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        .yt-cover-container:hover .yt-cover-img { opacity: 0.6; }
        .yt-play-btn {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 68px; height: 48px;
            background-color: rgba(33,33,33,0.8);
            border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            transition: background 0.2s;
        }
        .yt-cover-container:hover .yt-play-btn { background-color: red; }
        .yt-play-triangle {
            width: 0; height: 0;
            border-style: solid;
            border-width: 10px 0 10px 20px;
            border-color: transparent transparent transparent white;
        }
        .yt-cover-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <h1>ğŸ¨ VR æ•…äº‹ç·¨è¼¯å™¨</h1>
        <p>é»æ“Šé–‹å§‹ä»¥å•Ÿç”¨éŸ³æ•ˆèˆ‡éŒ„éŸ³æ¬Šé™</p>
        <div class="splash-actions">
            <button id="splash-btn" onclick="startApp()">ğŸš€ é–‹å§‹æ–°å‰µä½œ</button>
            <button id="import-btn" onclick="document.getElementById('import-input').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="import-input" accept=".html" onchange="importProject(event)">
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" onclick="toggleLightbox(false)">
        <img id="lightbox-img" src="">
    </div>

    <!-- Custom System Modal -->
    <div id="sys-modal">
        <div class="sys-modal-box">
            <div class="sys-modal-title" id="sys-title">æç¤º</div>
            <div class="sys-modal-msg" id="sys-msg">ç¢ºå®šåŸ·è¡Œå—ï¼Ÿ</div>
            <div class="sys-modal-btns">
                <button class="sys-btn sys-btn-cancel" onclick="closeSysModal()">å–æ¶ˆ</button>
                <button class="sys-btn sys-btn-ok" id="sys-ok-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- BGM Player (Runtime UI) -->
    <div id="bgm-player">
        <span id="bgm-icon">ğŸµ</span>
        <span id="bgm-status">BGM</span>
        <button id="bgm-toggle" onclick="toggleBGM()">â¸</button>
        <input type="range" id="bgm-vol" min="0" max="1" step="0.01" value="0.5" oninput="setBGMVolume(this.value)">
    </div>

    <a-scene id="vr-scene" raycaster="objects: .clickable, .raycast-target; interval: 0;" cursor="rayOrigin: mouse" vr-mode-ui="enabled: false">
        <a-sky id="sky-bg" color="#EEEEEE" class="raycast-target"></a-sky> 
        <a-entity id="rig" position="0 1.6 0"><a-entity id="camera" camera="zoom: 1" look-controls="reverseMouseDrag: true"></a-entity></a-entity>
        <a-entity id="hotspot-container"></a-entity>
    </a-scene>
    
    <div id="editor-ui">
        <div class="ui-panel ui-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:30px;">ğŸ¨</span>
                <div>
                    <h1>VR æ•…äº‹ç·¨è¼¯å™¨</h1>
                    <div class="author-info">Kang-miao Cheng, miao0309@miao.asia</div>
                </div>
            </div>
            <div style="display:flex; gap: 5px;">
                <button onclick="resetProject()" style="background:#FFB7B2; color:white;">ğŸ—‘ï¸ é‡æ–°é–‹å§‹</button>
                <button onclick="togglePreviewMode()" id="preview-btn">ğŸ‘ï¸ é è¦½</button>
                <button class="primary" onclick="exportProject()">ğŸ æ‰“åŒ…ä¸‹è¼‰</button>
            </div>
        </div>

        <div class="ui-panel ui-sidebar-left">
            <h2>ğŸ–¼ï¸ å ´æ™¯ç›¸ç°¿</h2>
            <div style="text-align: center; border-bottom: 2px dashed #aaa; padding-bottom:10px; margin-bottom:10px;">
                <button onclick="triggerUpload()" style="width:100%">+ ä¸Šå‚³å…¨æ™¯ç…§ç‰‡ (å¯å¤šé¸)</button>
                <input type="file" id="file-input" accept="image/*" multiple onchange="handleImageUpload(event)">
            </div>
            
            <div id="scene-properties" style="display:none; background:rgba(255,255,255,0.5); padding:10px; border-radius:5px; margin-bottom:10px; border:1px solid #999;">
                <label style="font-size:12px;">å ´æ™¯åç¨±:</label>
                <input type="text" id="scene-name-input" onchange="updateSceneName()">
                
                <div style="margin-top:10px; border-top:1px dashed #999; padding-top:5px;">
                    <label style="font-size:12px;">ğŸµ å ´æ™¯é…æ¨‚ (BGM):</label>
                    <button onclick="document.getElementById('bgm-input').click()" style="font-size:12px; margin-bottom:5px;">ğŸ“‚ ä¸Šå‚³éŸ³æ¨‚...</button>
                    <input type="file" id="bgm-input" accept="audio/*" onchange="handleBgmUpload(event)">
                    <div id="bgm-status-text" style="font-size:10px; color:#555; margin-bottom:5px;">(ç„¡)</div>
                    <label style="font-size:12px;">é è¨­éŸ³é‡:</label>
                    <input type="range" id="scene-bgm-vol" min="0" max="1" step="0.01" value="0.5" onchange="updateSceneBgmVol()">
                </div>
                <!-- Delete Button -->
                <button onclick="deleteCurrentScene()" style="background:#FF6B6B; color:white; width:100%; margin-top:15px;">ğŸ—‘ï¸ åˆªé™¤æ­¤å ´æ™¯</button>
            </div>

            <!-- Scene List Container -->
            <div id="scene-list-container">
                <div id="scene-list-header">ğŸ“œ æ‰€æœ‰å ´æ™¯ (0)</div>
                <div id="scene-list">
                    <div style="padding:20px; text-align:center; color:#888;">å°šæœªä¸Šå‚³å ´æ™¯</div>
                </div>
            </div>
        </div>

        <div class="ui-panel ui-sidebar-right">
            <h2>ğŸ§° å·¥å…·ç®±</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button onclick="addHotspotMode('link')">ğŸšª å‚³é€é–€</button>
                <button onclick="addHotspotMode('info')">ğŸ’¬ è¨Šæ¯</button>
                <button onclick="addHotspotMode('label')">ğŸ·ï¸ æ¨™ç±¤</button>
                <button onclick="addHotspotMode('quiz')">â“ æ¸¬é©—</button>
                <button onclick="addHotspotMode('embed')">ğŸŒ å…§åµŒ</button>
                <button onclick="addHotspotMode('tts')">ğŸ”Š èªéŸ³</button>
            </div>
            
            <div id="properties-panel" style="display:none; margin-top: 15px; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; border: 2px dotted white;">
                <h3>âœï¸ ç·¨è¼¯å…§å®¹</h3>
                
                <label>æ¨™é¡Œ / é¡Œç›® / å…§å®¹:</label>
                <input type="text" id="prop-text">
                
                <!-- LINK -->
                <div id="prop-link-group" class="prop-group" style="display:none;">
                    <label>å‰å¾€å ´æ™¯:</label>
                    <select id="prop-target"></select>
                    <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="prop-link-lock" style="width:auto;" onchange="toggleLinkLock()"> 
                        <label for="prop-link-lock" style="font-size:12px;">éœ€å›ç­”å•é¡Œæ‰èƒ½å‚³é€?</label>
                    </div>
                </div>

                <!-- INFO (with Image and Video) -->
                <div id="prop-info-group" class="prop-group" style="display:none;">
                    <label>é™„åŠ å¤šåª’é«” (é¸å¡«):</label>
                    <button onclick="document.getElementById('info-img-input').click()" style="margin-bottom:5px; font-size:12px;">ğŸ–¼ï¸ é¸æ“‡åœ–ç‰‡...</button>
                    <input type="file" id="info-img-input" accept="image/*" onchange="handleInfoImgUpload(event)">
                    <div id="info-img-status" style="font-size:10px; color:green; margin-bottom:5px;"></div>
                    
                    <button onclick="document.getElementById('info-video-input').click()" style="margin-bottom:5px; font-size:12px;">ğŸ¬ é¸æ“‡å½±ç‰‡...</button>
                    <input type="file" id="info-video-input" accept="video/*" onchange="handleInfoVideoUpload(event)">
                    <div id="info-video-status" style="font-size:10px; color:green; margin-bottom:5px;"></div>
                </div>

                <!-- QUIZ -->
                <div id="prop-quiz-group" class="prop-group" style="display:none;">
                    <div style="margin-bottom:10px; border:1px solid #ccc; padding:5px; border-radius:5px; background:#fff;">
                        <label>ğŸµ è½åŠ›éŸ³æª” (é¸å¡«):</label>
                        <button onclick="document.getElementById('quiz-audio-input').click()" style="font-size:12px;">ğŸ“‚ é¸æ“‡éŸ³æª”...</button>
                        <input type="file" id="quiz-audio-input" accept="audio/*" onchange="handleQuizAudioUpload(event)">
                        <div id="quiz-audio-status" style="font-size:10px; color:green;"></div>
                        <!-- New: Delete button for quiz audio -->
                        <button class="delete-audio-btn" onclick="deleteAudio('quiz')" style="width:100%; margin-top:5px;">ğŸ—‘ï¸ åˆªé™¤éŸ³æª”</button>
                    </div>

                    <label>é¡Œå‹:</label>
                    <select id="prop-quiz-type" onchange="updateQuizUI()">
                        <option value="choice">é¸æ“‡é¡Œ (å–®/è¤‡é¸)</option>
                        <option value="fill">å¡«å……é¡Œ</option>
                        <option value="sort">æ’åºé¡Œ</option>
                    </select>

                    <div id="quiz-choice-inputs" style="margin-top:5px;">
                        <label>é¸é … (å‹¾é¸å³ç‚ºæ­£ç¢ºç­”æ¡ˆ):</label>
                        <div class="quiz-opt-row"><input type="checkbox" id="chk-opt-0"><input type="text" id="inp-opt-0" placeholder="é¸é … 1"></div>
                        <div class="quiz-opt-row"><input type="checkbox" id="chk-opt-1"><input type="text" id="inp-opt-1" placeholder="é¸é … 2"></div>
                        <div class="quiz-opt-row"><input type="checkbox" id="chk-opt-2"><input type="text" id="inp-opt-2" placeholder="é¸é … 3"></div>
                        <div class="quiz-opt-row"><input type="checkbox" id="chk-opt-3"><input type="text" id="inp-opt-3" placeholder="é¸é … 4"></div>
                    </div>

                    <div id="quiz-fill-inputs" style="display:none;">
                        <label>æ­£ç¢ºç­”æ¡ˆ (å¤šå€‹å¯ç”¨é€—è™Ÿåˆ†éš”):</label>
                        <input type="text" id="prop-fill-answer" placeholder="ä¾‹å¦‚ï¼šè˜‹æœ,apple">
                    </div>

                    <div id="quiz-sort-inputs" style="display:none;">
                        <label>æ­£ç¢ºé †åº (ç”¨é€—è™Ÿåˆ†éš”):</label>
                        <input type="text" id="prop-sort-answer" placeholder="èµ·åºŠ,åˆ·ç‰™,æ´—è‡‰">
                    </div>

                    <label style="margin-top:5px;">ç­”éŒ¯å›é¥‹è¨Šæ¯:</label>
                    <input type="text" id="prop-quiz-feedback" placeholder="å“å‘€ï¼å†è©¦è©¦çœ‹ï¼">
                </div>

                <!-- EMBED -->
                <div id="prop-embed-group" class="prop-group" style="display:none;">
                    <label>å…§åµŒä»£ç¢¼ / YouTubeç¶²å€:</label>
                    <textarea id="prop-embed-code" rows="3" placeholder='https://youtu.be/...'></textarea>
                </div>

                <!-- TTS / AUDIO -->
                <div id="prop-tts-group" class="prop-group" style="display:none;">
                    <div class="radio-group">
                        <label><input type="radio" name="audioMode" value="tts" onclick="toggleAudioMode()"> è½‰èªéŸ³</label>
                        <label><input type="radio" name="audioMode" value="upload" onclick="toggleAudioMode()"> ä¸Šå‚³</label>
                        <label><input type="radio" name="audioMode" value="record" onclick="toggleAudioMode()"> éŒ„éŸ³</label>
                    </div>

                    <!-- TTS Sub-panel -->
                    <div id="mode-tts-panel">
                        <label>æœ—è®€å…§å®¹:</label>
                        <textarea id="prop-tts-content" rows="3" placeholder="è«‹è¼¸å…¥è¦æœ—è®€çš„æ–‡å­—..."></textarea>
                        
                        <label>èªè¨€:</label>
                        <select id="prop-tts-lang">
                            <option value="zh-TW">ä¸­æ–‡ (å°ç£)</option>
                            <option value="en-US">è‹±æ–‡ (ç¾åœ‹)</option>
                            <option value="ja-JP">æ—¥æ–‡</option>
                        </select>

                        <label style="margin-top:5px;">é¸æ“‡è²éŸ³:</label>
                        <select id="prop-tts-preset" onchange="applyVoicePreset()">
                            <option value="default">é è¨­</option>
                            <option value="m1">ç”·ç”Ÿ (ç©©é‡)</option>
                            <option value="m2">ç”·ç”Ÿ (å¹´è¼•)</option>
                            <option value="f1">å¥³ç”Ÿ (æº«æŸ”)</option>
                            <option value="f2">å¥³ç”Ÿ (æ´»æ½‘)</option>
                        </select>
                        <div style="display:none;">
                            <input type="number" id="prop-tts-pitch" step="0.1" value="1">
                            <input type="number" id="prop-tts-rate" step="0.1" value="1">
                        </div>
                        
                        <div class="audio-control-row">
                            <button onclick="previewTTS()" style="background: #e0f7fa;">ğŸ”Š è©¦è½</button>
                            <button onclick="stopTTS()" style="background: #ffecb3;">â¹ åœæ­¢</button>
                        </div>
                    </div>

                    <!-- Upload Sub-panel -->
                    <div id="mode-upload-panel" style="display:none;">
                        <label>é¸æ“‡éŸ³æª” (MP3/WAV):</label>
                        <button onclick="document.getElementById('audio-input').click()" style="margin-bottom:5px;">ğŸ“‚ é¸æ“‡æª”æ¡ˆ...</button>
                        <input type="file" id="audio-input" accept="audio/*" onchange="handleAudioUpload(event)">
                        <div id="audio-file-status" style="font-size:12px; color:green; margin-bottom:5px;"></div>
                        <div class="audio-control-row">
                            <button onclick="previewUploadedAudio()" style="background: #e0f7fa;">â–¶ è©¦è½æª”æ¡ˆ</button>
                            <button onclick="stopTTS()" style="background: #ffecb3;">â¹ åœæ­¢</button>
                            <!-- New: Delete button for uploaded audio -->
                            <button class="delete-audio-btn" onclick="deleteAudio('tts')">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>

                    <!-- Record Sub-panel -->
                    <div id="mode-record-panel" style="display:none;">
                        <label>éŒ„è£½èªéŸ³:</label>
                        <div id="record-status" style="color:red; font-size:12px; margin-bottom:5px;"></div>
                        <div class="audio-control-row">
                            <button id="btn-record-start" onclick="startRecording()" class="record-btn">âº é–‹å§‹éŒ„éŸ³</button>
                            <button id="btn-record-stop" onclick="stopRecording()" disabled>â¹ åœæ­¢</button>
                        </div>
                        <div class="audio-control-row">
                             <button onclick="previewUploadedAudio()" style="margin-top:5px; background: #e0f7fa;">â–¶ è©¦è½éŒ„éŸ³</button>
                             <button onclick="stopTTS()" style="margin-top:5px; background: #ffecb3;">â¹ åœæ­¢</button>
                             <!-- New: Delete button for recorded audio -->
                             <button class="delete-audio-btn" style="margin-top:5px;" onclick="deleteAudio('tts')">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                </div>
                
                <button class="save-btn" onclick="saveHotspotChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                <!-- RESTORED: Delete Selected Hotspot button -->
                <button style="background:#FF6B6B; color:white; width:100%; margin-top:5px;" onclick="deleteSelectedHotspot()">ğŸ—‘ï¸ åˆªé™¤æ­¤ç†±é»</button>
            </div>
            
            <div id="no-selection-msg" style="padding:20px; text-align:center; color:#888; margin-top:20px;">
                é»é¸ç•«é¢ä¸Šçš„åœ–ç¤º<br>å³å¯é–‹å§‹ç·¨è¼¯
            </div>
        </div>
    </div>

    <!-- UI Feedbacks -->
    <div id="toast"></div>
    <div id="loading"><h1 style="font-size:32px;">è™•ç†ä¸­...</h1></div>

    <!-- Runtime Overlay -->
    <div id="runtime-overlay" class="speech-bubble">
        <div class="close-btn" onclick="closeOverlay()">X</div>
        <div class="speech-content">
            <h2 id="overlay-title" style="color: #0056b3;">TITLE</h2>
            <div id="overlay-content" style="font-size: 18px; line-height: 1.5; margin-top:10px;"></div>
            <div id="overlay-feedback" style="color:red; font-weight:bold; margin-top:10px; display:none;"></div>
            <div id="overlay-actions" style="margin-top:15px;"></div>
        </div>
    </div>

    <script id="main-script">
        // --- DATA STATE ---
        let projectData = { title: "My VR Story", scenes: [] };
        let currentSceneId = null;
        let selectedHotspotId = null;
        let isPreviewMode = false;
        let isDragging = false;
        let draggedHotspotId = null;
        let tempAudioBase64 = null;
        let tempQuizAudioBase64 = null; 
        let tempInfoImgBase64 = null;
        let tempInfoVideoBase64 = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentBgmAudio = null;
        let dragSrcEl = null;

        const skyEl = document.querySelector('#sky-bg');
        const hotspotContainer = document.querySelector('#hotspot-container');
        const propertiesPanel = document.querySelector('#properties-panel');
        const noSelectionMsg = document.querySelector('#no-selection-msg');
        const toast = document.getElementById('toast');
        const sceneEl = document.querySelector('a-scene');
        const cameraEl = document.querySelector('#camera');

        // --- GLOBAL: Load YouTube Function (Data URI Iframe Technique for Error 153) ---
        window.loadYoutube = function(id, vid) {
            const container = document.getElementById(id);
            if (!container) return;
            
            // Construct full HTML for data URI
            const htmlContent = `
                <!DOCTYPE html>
                <html style="overflow:hidden;">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>body{margin:0;background:black;height:100vh;display:flex;justify-content:center;align-items:center;}iframe{width:100%;height:100%;border:0}</style>
                </head>
                <body>
                    <iframe 
                        src="https://www.youtube.com/embed/${vid}?autoplay=1&playsinline=1&rel=0&modestbranding=1" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen>
                    </iframe>
                </body>
                </html>
            `;
            
            // Encode as Data URI
            const dataUri = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);

            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            iframe.src = dataUri;
            
            container.innerHTML = '';
            container.appendChild(iframe);
        };

        // --- APP STARTUP & IMPORT ---
        async function startApp() {
            try {
                if (typeof AFRAME === 'undefined') {
                    alert("3D å¼•æ“è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š (A-Frame load failed)");
                    return;
                }
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Mic Permission Granted");
            } catch(e) {
                console.warn("Mic permission denied/ignored", e);
                showConfirm("æ¬Šé™æç¤º", "æ‚¨æœªæˆæ¬Šéº¥å…‹é¢¨ï¼ŒéŒ„éŸ³åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚", null);
            }
            document.getElementById('splash-screen').style.display = 'none';
            loadVoices();
            loadProjectFromDB();
        }

        async function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                let importedData = null;

                // Priority 1: New Encoded Format
                const encodedMatch = content.match(/window\.exportedData\s*=\s*JSON\.parse\(decodeURIComponent\("([^"]+)"\)\);/);
                if (encodedMatch && encodedMatch[1]) {
                     try { importedData = JSON.parse(decodeURIComponent(encodedMatch[1])); } catch(e){}
                }

                // Priority 2: Fallback (Sandbox execution for legacy files)
                if (!importedData) {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.sandbox = "allow-same-origin allow-scripts";
                    document.body.appendChild(iframe);
                    try {
                        const doc = iframe.contentWindow.document;
                        doc.open();
                        doc.write(content);
                        doc.close();
                        await new Promise(r => setTimeout(r, 500)); // Wait for script execution
                        const win = iframe.contentWindow;
                        if(win.exportedData) importedData = win.exportedData;
                        else if(win.projectData && win.projectData.title) importedData = win.projectData;
                        else if(win.data && win.data.title) importedData = win.data;
                    } catch(e) { console.warn("Sandbox import failed", e); }
                    finally { document.body.removeChild(iframe); }
                }

                if (importedData) {
                    projectData = importedData;
                    if(!db) await initDB();
                    const t=db.transaction([STORE_NAME],'readwrite'),s=t.objectStore(STORE_NAME);
                    s.put({id:'current_project',data:projectData});
                    
                    if (projectData.scenes.length > 0) {
                        currentSceneId = null;
                        selectedHotspotId = null;
                        renderSceneList();
                        switchScene(projectData.scenes[0].id);
                        showToast("åŒ¯å…¥æˆåŠŸï¼");
                    } else {
                        showToast("åŒ¯å…¥æˆåŠŸï¼Œä½†å°ˆæ¡ˆæ˜¯ç©ºçš„");
                    }
                    document.getElementById('splash-screen').style.display = 'none';
                } else {
                    alert("åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•è¾¨è­˜æª”æ¡ˆå…§å®¹");
                }
                document.getElementById('loading').style.display = 'none';
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- INDEXED DB ---
        let db; const DB_NAME = 'PopVR_DB', STORE_NAME = 'projects';
        function initDB() {
            return new Promise((resolve,reject)=>{
                const r=indexedDB.open(DB_NAME,1);
                r.onupgradeneeded=(e)=>{const d=e.target.result;if(!d.objectStoreNames.contains(STORE_NAME))d.createObjectStore(STORE_NAME,{keyPath:'id'});};
                r.onsuccess=(e)=>{db=e.target.result;resolve(db);};r.onerror=(e)=>reject(e);
            });
        }
        async function saveToLocal() {
            if(!db)await initDB();
            const t=db.transaction([STORE_NAME],'readwrite'),s=t.objectStore(STORE_NAME);
            s.put({id:'current_project',data:projectData});
        }
        async function loadFromLocal() {
            if(!db)await initDB();
            return new Promise(resolve=>{
                const t=db.transaction([STORE_NAME],'readonly'),s=t.objectStore(STORE_NAME),r=s.get('current_project');
                r.onsuccess=()=>{resolve(r.result?r.result.data:null);};r.onerror=()=>resolve(null);
            });
        }

        async function loadProjectFromDB() {
            try {
                const saved = await loadFromLocal();
                if(saved && saved.scenes && saved.scenes.length > 0) {
                    projectData = saved;
                    renderSceneList();
                    switchScene(projectData.scenes[0].id);
                    showToast("å·²è¼‰å…¥ä¸Šæ¬¡çš„é€²åº¦ï¼");
                }
            } catch(e) { console.error(e); }
        }

        // --- VOICE LOADING ---
        let availableVoices = [];
        function loadVoices() { availableVoices = window.speechSynthesis.getVoices(); }
        window.speechSynthesis.onvoiceschanged = loadVoices;

        // --- ZOOM CONTROL ---
        document.addEventListener('wheel', (e) => {
            if (e.target.closest('.ui-panel')) return;
            e.preventDefault();
            const cam = document.getElementById('camera');
            if(!cam) return;
            let zoom = parseFloat(cam.getAttribute('camera').zoom) || 1;
            zoom -= e.deltaY * 0.001;
            zoom = Math.min(Math.max(0.8, zoom), 4);
            cam.setAttribute('camera', 'zoom', zoom);
        }, { passive: false });

        function showToast(msg) { toast.innerText = msg; toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 2000); }

        // --- CUSTOM CONFIRM MODAL ---
        function showConfirm(title, msg, onConfirm) {
            document.getElementById('sys-title').innerText = title;
            document.getElementById('sys-msg').innerText = msg;
            document.getElementById('sys-modal').style.display = 'flex';
            const okBtn = document.getElementById('sys-ok-btn');
            
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            if (onConfirm) {
                newOkBtn.style.display = 'block';
                newOkBtn.onclick = () => {
                    closeSysModal();
                    onConfirm();
                };
            } else {
                newOkBtn.style.display = 'none'; 
            }
        }
        function closeSysModal() { document.getElementById('sys-modal').style.display = 'none'; }

        // --- SVG ICONS ---
        function getIconSVG(type) {
            let svg = '';
            if (type === 'link') svg = `<rect x="25" y="15" width="50" height="70" fill="#8B4513" stroke="black" stroke-width="3"/><circle cx="65" cy="50" r="5" fill="#FFD700" stroke="black" stroke-width="1"/>`;
            else if (type === 'info') svg = `<path d="M10,25 Q10,10 50,10 Q90,10 90,25 Q90,50 50,50 Q40,50 30,60 L25,50 Q10,50 10,25 Z" fill="white" stroke="black" stroke-width="3"/><text x="50" y="38" font-family="Comic Sans MS" font-size="30" text-anchor="middle" fill="black">...</text>`;
            else if (type === 'quiz') svg = `<circle cx="50" cy="50" r="40" fill="#FFB7B2" stroke="black" stroke-width="3"/><text x="50" y="70" font-family="Arial" font-weight="bold" font-size="60" text-anchor="middle" fill="white">?</text>`;
            else if (type === 'embed') svg = `<circle cx="50" cy="50" r="40" fill="#4fa3d1" stroke="black" stroke-width="3"/><ellipse cx="50" cy="50" rx="20" ry="40" fill="none" stroke="black" stroke-width="2"/><line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="2"/><line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="2"/>`;
            else if (type === 'tts') svg = `<path d="M10,40 L30,40 L50,20 L50,80 L30,60 L10,60 Z" fill="#FFA500" stroke="black" stroke-width="3"/><path d="M60,30 Q80,50 60,70 M70,20 Q100,50 70,80" stroke="black" stroke-width="3" fill="none"/>`;
            else if (type === 'label') svg = `<rect x="10" y="30" width="80" height="40" fill="#FFFACD" stroke="black" stroke-width="2"/><circle cx="50" cy="20" r="5" fill="#333"/>`;
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">${svg}</svg>`)));
        }

        function createLabelTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFACD'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
            ctx.lineWidth = 10; ctx.strokeStyle = '#555555'; ctx.strokeRect(0, 0, canvas.width, canvas.height); 
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 40px "Microsoft JhengHei", "Comic Sans MS", sans-serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const words = text.split(''); let line = ''; let lines = []; const maxWidth = 480; const lineHeight = 50;
            for(let n = 0; n < text.length; n++) {
                const testLine = line + text[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) { lines.push(line); line = text[n]; } else { line = testLine; }
            }
            lines.push(line);
            const startY = (canvas.height - (lines.length * lineHeight)) / 2 + (lineHeight/2);
            lines.forEach((l, i) => { ctx.fillText(l, canvas.width / 2, startY + (i * lineHeight)); });
            return canvas.toDataURL('image/png');
        }

        // --- SCENE & HOTSPOTS ---
        function triggerUpload() { document.getElementById('file-input').click(); }
        
        async function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            document.getElementById('loading').style.display = 'flex';
            
            const readFile = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ name: file.name.split('.')[0], data: e.target.result });
                    reader.readAsDataURL(file);
                });
            };

            const promises = Array.from(files).map(file => readFile(file));
            
            try {
                const results = await Promise.all(promises);
                let firstNewId = null;
                
                results.forEach((res, index) => {
                    const id = 'scene_' + Date.now() + '_' + index;
                    if (index === 0) firstNewId = id;
                    projectData.scenes.push({
                        id: id,
                        name: res.name,
                        image: res.data,
                        hotspots: [],
                        rotation: 0,
                        bgmSrc: null,
                        bgmVolume: 0.5
                    });
                });

                saveToLocal();
                renderSceneList();
                if (firstNewId && !currentSceneId) switchScene(firstNewId);
                else if (firstNewId) switchScene(firstNewId);

                showToast(`å·²æ–°å¢ ${results.length} å€‹å ´æ™¯ï¼`);
            } catch (error) {
                console.error(error);
                alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—");
            } finally {
                document.getElementById('loading').style.display = 'none';
                event.target.value = '';
            }
        }

        function deleteCurrentScene() {
            if (!currentSceneId) { alert("éŒ¯èª¤ï¼šæœªé¸å–ä»»ä½•å ´æ™¯"); return; }
            deleteScene(currentSceneId);
        }

        function deleteScene(targetId) {
            if (!targetId) return;
            
            const index = projectData.scenes.findIndex(s => s.id === targetId);
            if (index === -1) return;

            showConfirm("åˆªé™¤ç¢ºèª", "ç¢ºå®šè¦åˆªé™¤é€™å€‹å ´æ™¯å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸå–”ï¼", () => {
                projectData.scenes.splice(index, 1);
                projectData.scenes.forEach(s => {
                    if (s.hotspots) {
                        s.hotspots.forEach(h => { if (h.type === 'link' && h.targetScene === targetId) h.targetScene = ''; });
                    }
                });
                saveToLocal();
                if (targetId === currentSceneId) {
                    if (projectData.scenes.length > 0) switchScene(projectData.scenes[0].id);
                    else {
                        currentSceneId = null;
                        renderSceneList();
                        skyEl.removeAttribute('src');
                        hotspotContainer.innerHTML = '';
                        document.getElementById('scene-properties').style.display = 'none';
                        document.getElementById('scene-name-input').value = '';
                        stopAllAudio();
                    }
                } else { renderSceneList(); }
                showToast("ğŸ—‘ï¸ å ´æ™¯å·²åˆªé™¤");
            });
        }

        function resetProject() {
            showConfirm("é‡æ–°é–‹å§‹", "ç¢ºå®šè¦é‡æ–°é–‹å§‹ï¼ˆé–‹æ–°å°ˆæ¡ˆï¼‰å—ï¼Ÿç›®å‰çš„é€²åº¦å°‡æœƒéºå¤±ï¼ˆé™¤éæ‚¨å·²ä¸‹è¼‰å‚™ä»½ï¼‰ã€‚", () => {
                projectData = { title: "My VR Story", scenes: [] };
                currentSceneId = null;
                selectedHotspotId = null;
                saveToLocal();
                renderSceneList();
                skyEl.removeAttribute('src');
                hotspotContainer.innerHTML = '';
                document.getElementById('scene-properties').style.display = 'none';
                document.getElementById('splash-screen').style.display = 'flex';
            });
        }

        // --- Drag and Drop Handlers for Scene List ---
        function dragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function dragOver(e) { if (e.preventDefault) { e.preventDefault(); } e.dataTransfer.dropEffect = 'move'; this.classList.add('over'); return false; }
        function dragEnter(e) { this.classList.add('over'); }
        function dragLeave(e) { this.classList.remove('over'); }
        function dragEnd(e) { this.classList.remove('dragging'); this.classList.remove('over'); document.querySelectorAll('.scene-item').forEach(item => item.classList.remove('over')); }

        function dragDrop(e) {
            if (e.stopPropagation) { e.stopPropagation(); }
            if (dragSrcEl !== this) {
                const srcIdx = parseInt(dragSrcEl.getAttribute('data-index'));
                const targetIdx = parseInt(this.getAttribute('data-index'));
                const item = projectData.scenes[srcIdx];
                projectData.scenes.splice(srcIdx, 1);
                projectData.scenes.splice(targetIdx, 0, item);
                saveToLocal();
                renderSceneList();
            }
            return false;
        }

        function renderSceneList() {
            const listEl = document.getElementById('scene-list');
            const headerEl = document.getElementById('scene-list-header');
            const tSelect = document.getElementById('prop-target'); 
            
            if(!listEl) return;

            listEl.innerHTML=''; 
            if(tSelect) tSelect.innerHTML='<option value="">-- é¸æ“‡ç›®æ¨™å ´æ™¯ --</option>';
            
            if (headerEl) headerEl.innerText = `ğŸ“œ æ‰€æœ‰å ´æ™¯ (${projectData.scenes.length})`;

            if (projectData.scenes.length === 0) {
                listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">å°šæœªä¸Šå‚³å ´æ™¯</div>';
                return;
            }

            projectData.scenes.forEach((s, index) => {
                const d=document.createElement('div');
                d.className=`scene-item ${s.id===currentSceneId?'active':''}`;
                d.setAttribute('draggable', 'true');
                d.setAttribute('data-index', index);
                
                d.addEventListener('dragstart', dragStart, false);
                d.addEventListener('dragenter', dragEnter, false);
                d.addEventListener('dragover', dragOver, false);
                d.addEventListener('dragleave', dragLeave, false);
                d.addEventListener('drop', dragDrop, false);
                d.addEventListener('dragend', dragEnd, false);
                
                const nameSpan = document.createElement('span');
                nameSpan.innerHTML = `<b>${s.name}</b>`;
                nameSpan.className = 'scene-name-span';
                nameSpan.onclick = (e) => { switchScene(s.id); };

                const delBtn = document.createElement('span');
                delBtn.innerText = "âŒ";
                delBtn.className = "delete-scene-btn";
                delBtn.title = "åˆªé™¤æ­¤å ´æ™¯";
                delBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    deleteScene(s.id); 
                };

                d.appendChild(nameSpan);
                d.appendChild(delBtn);
                listEl.appendChild(d);
                
                if(tSelect) {
                    const o=document.createElement('option');
                    o.value=s.id;
                    o.innerText=s.name;
                    tSelect.appendChild(o);
                }
            });
        }

        function stopAllAudio() {
            window.speechSynthesis.cancel();
            if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; currentAudioObj = null; }
            if(currentBgmAudio) { currentBgmAudio.pause(); currentBgmAudio.currentTime = 0; currentBgmAudio = null; }
            document.getElementById('bgm-player').style.display = 'none';
        }

        function playSceneBGM(scene) {
            if (scene.bgmSrc) {
                currentBgmAudio = new Audio(scene.bgmSrc);
                currentBgmAudio.loop = true;
                currentBgmAudio.volume = scene.bgmVolume !== undefined ? scene.bgmVolume : 0.5;
                currentBgmAudio.play().catch(e=>console.log("Auto-play blocked"));
                
                const player = document.getElementById('bgm-player');
                player.style.display = 'flex';
                document.getElementById('bgm-toggle').innerText = "â¸";
                document.getElementById('bgm-vol').value = currentBgmAudio.volume;
            }
        }

        function switchScene(id) {
            const s = projectData.scenes.find(x => x.id === id);
            if (!s) { alert("ç›®æ¨™å ´æ™¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤ï¼"); return; }
            
            currentSceneId = id; 
            skyEl.setAttribute('src', s.image);
            
            try {
                document.getElementById('scene-properties').style.display = 'block';
                document.getElementById('scene-name-input').value = s.name;
                document.getElementById('bgm-status-text').innerText = s.bgmSrc ? "âœ… å·²è¨­å®š BGM" : "(ç„¡)";
                document.getElementById('scene-bgm-vol').value = s.bgmVolume !== undefined ? s.bgmVolume : 0.5;
            } catch(e) { console.error(e); }

            renderSceneList();
            renderHotspots();
            deselectHotspot();

            try {
                stopAllAudio(); 
                playSceneBGM(s);
            } catch(e) { console.error("Audio error during switch", e); }
        }

        function handleBgmUpload(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const s = projectData.scenes.find(x=>x.id===currentSceneId);
                s.bgmSrc = e.target.result;
                document.getElementById('bgm-status-text').innerText = "âœ… å·²è¨­å®š BGM";
                saveToLocal();
                stopAllAudio(); playSceneBGM(s);
            };
            reader.readAsDataURL(file);
        }

        function updateSceneBgmVol() {
            const vol = parseFloat(document.getElementById('scene-bgm-vol').value);
            const s = projectData.scenes.find(x=>x.id===currentSceneId);
            s.bgmVolume = vol;
            if(currentBgmAudio) currentBgmAudio.volume = vol;
            saveToLocal();
        }

        function toggleBGM() {
            if(!currentBgmAudio) return;
            if(currentBgmAudio.paused) {
                currentBgmAudio.play();
                document.getElementById('bgm-toggle').innerText = "â¸";
            } else {
                currentBgmAudio.pause();
                document.getElementById('bgm-toggle').innerText = "â–¶";
            }
        }
        function setBGMVolume(val) {
            if(currentBgmAudio) currentBgmAudio.volume = val;
        }

        function updateSceneName(){
            if(!currentSceneId)return;
            const s=projectData.scenes.find(x=>x.id===currentSceneId);
            s.name=document.getElementById('scene-name-input').value;
            saveToLocal();renderSceneList();
        }

        function addHotspotMode(type) {
            if(!currentSceneId){alert("è«‹å…ˆä¸Šå‚³å ´æ™¯å–”ï¼");return;}
            if (!cameraEl.object3D) {
                alert("3D å ´æ™¯å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦");
                return;
            }
            const camPos = new THREE.Vector3();
            cameraEl.object3D.getWorldPosition(camPos);
            const camRot = cameraEl.object3D.rotation; 
            
            const dir = new THREE.Vector3(0, 0, -1);
            dir.applyQuaternion(cameraEl.object3D.quaternion);
            
            const dist = 3.0; 
            const newPos = new THREE.Vector3().copy(camPos).add(dir.multiplyScalar(dist));
            
            const nh={
                id:'hs_'+Date.now(), type:type,
                position:`${newPos.x.toFixed(2)} ${newPos.y.toFixed(2)} ${newPos.z.toFixed(2)}`,
                text:type==='quiz'?'é¡Œç›®':(type==='embed'?'å½±ç‰‡/ç¶²é ':(type==='tts'?'èªéŸ³æ¨™é¡Œ':(type==='label'?'æ–°æ¨™ç±¤':'æ¨™é¡Œ'))),
                targetScene:'', lockQuestion:false,
                quizType:'choice', 
                quizData:{ options:[{t:'é¸é …A',c:true},{t:'é¸é …B',c:false}], fillAnswer:'', sortAnswer:'', feedback:'', audioSrc:null },
                embedCode:'',
                infoData:{ imageSrc: null, videoSrc: null },
                ttsData: { mode: 'tts', content: 'æ­¡è¿ä½¿ç”¨ VR æ•…äº‹ç·¨è¼¯å™¨', lang: 'zh-TW', preset: 'default', pitch: 1, rate: 1, audioSrc: null }
            };
            const s=projectData.scenes.find(x=>x.id===currentSceneId);
            s.hotspots.push(nh);saveToLocal();renderHotspots();selectHotspot(nh.id);showToast(`å·²æ–°å¢ ${type}ï¼`);
        }

        function renderHotspots() {
            hotspotContainer.innerHTML='';
            const s=projectData.scenes.find(x=>x.id===currentSceneId); if(!s)return;
            s.hotspots.forEach(h=>{
                const e=document.createElement('a-entity');
                e.setAttribute('position',h.position);
                e.setAttribute('look-at','#camera');
                e.classList.add('clickable');e.setAttribute('data-id',h.id);
                
                if (h.type === 'label') {
                    const plane = document.createElement('a-image');
                    plane.setAttribute('src', createLabelTexture(h.text));
                    plane.setAttribute('width', '1.5'); plane.setAttribute('height', '0.75');
                    plane.classList.add('clickable');
                    e.appendChild(plane);
                } else {
                    const v=document.createElement('a-image');v.setAttribute('src',getIconSVG(h.type));
                    v.setAttribute('width','0.8');v.setAttribute('height','0.8');
                    v.setAttribute('animation','property:scale;to:0.9 0.9 0.9;dir:alternate;dur:1000;loop:true');v.classList.add('clickable');
                    const t=document.createElement('a-text');
                    let l='Info';if(h.type==='link')l=h.lockQuestion?'ğŸ”’ GO':'GO';else if(h.type==='quiz')l='Quiz';else if(h.type==='embed')l='Web';else if(h.type==='tts')l='Voice';
                    t.setAttribute('value',l);t.setAttribute('align','center');
                    t.setAttribute('position','0 -0.6 0');t.setAttribute('scale','1.2 1.2 1.2');t.setAttribute('color','#333');
                    e.appendChild(v);e.appendChild(t);
                }

                e.addEventListener('mousedown',()=>{
                    if(isPreviewMode)return; isDragging=true;draggedHotspotId=h.id;
                    cameraEl.setAttribute('look-controls', 'enabled', false); // FIX: Proper syntax
                    selectHotspot(h.id);
                });
                e.addEventListener('click',()=>{if(isPreviewMode && h.type !== 'label')triggerHotspotAction(h);});
                hotspotContainer.appendChild(e);
            });
        }

        // DRAG LOGIC MOVED TO DOCUMENT LEVEL FOR STABILITY
        document.addEventListener('mouseup',()=>{
            if(isDragging){
                isDragging=false;
                draggedHotspotId=null;
                cameraEl.setAttribute('look-controls', 'enabled', true); // FIX: Proper syntax
                saveToLocal();
            }
        });

        document.addEventListener('mousemove',(evt)=>{
            if(!isDragging || !draggedHotspotId || !currentSceneId) return;

            // Important: Raycaster logic needs the mouse position relative to canvas
            // A-Frame cursor component usually handles raycaster updates.
            // We rely on the scene's raycaster having been updated by the cursor component (driven by mouse)
            
            const rc = sceneEl.components.raycaster;
            if(!rc || !rc.intersections) return;
            
            // Look for intersection with sky
            const si = rc.intersections.find(i => i.object.el && i.object.el.classList.contains('raycast-target'));
            
            if(si){
                const p = si.point;
                const cp = new THREE.Vector3();
                cameraEl.object3D.getWorldPosition(cp);
                
                // Keep the hotspot at a constant distance (e.g. 3m) from camera to avoid it getting stuck on the sky sphere
                const d = new THREE.Vector3().copy(p).sub(cp).normalize();
                const np = new THREE.Vector3().copy(cp).add(d.multiplyScalar(3.0));
                
                const el = document.querySelector(`a-entity[data-id="${draggedHotspotId}"]`);
                if(el) el.setAttribute('position', np);
                
                const s = projectData.scenes.find(x => x.id === currentSceneId);
                const h = s.hotspots.find(x => x.id === draggedHotspotId);
                if(h) h.position = `${np.x.toFixed(2)} ${np.y.toFixed(2)} ${np.z.toFixed(2)}`;
            }
        });

        // --- PROPERTIES ---
        function selectHotspot(id) {
            selectedHotspotId=id; const s=projectData.scenes.find(x=>x.id===currentSceneId), h=s.hotspots.find(x=>x.id===id);
            if(propertiesPanel) propertiesPanel.style.display='block';
            if(noSelectionMsg) noSelectionMsg.style.display='none';
            document.getElementById('prop-text').value=h.text||'';
            document.querySelectorAll('.prop-group').forEach(el => el.style.display='none');

            if(h.type==='link'){ 
                document.getElementById('prop-link-group').style.display='block';
                const tSelect = document.getElementById('prop-target');
                if(tSelect.options.length <= 1) { 
                     renderSceneList(); 
                }
                tSelect.value=h.targetScene||''; 
                document.getElementById('prop-link-lock').checked=h.lockQuestion||false; 
                if(h.lockQuestion) document.getElementById('prop-quiz-group').style.display='block';
            }
            else if(h.type==='info'){
                document.getElementById('prop-info-group').style.display='block';
                tempInfoImgBase64 = null; tempInfoVideoBase64 = null;
                document.getElementById('info-img-status').innerText = (h.infoData && h.infoData.imageSrc) ? "âœ… ç›®å‰å·²æœ‰åœ–ç‰‡" : "";
                document.getElementById('info-video-status').innerText = (h.infoData && h.infoData.videoSrc) ? "âœ… ç›®å‰å·²æœ‰å½±ç‰‡" : "";
            }
            else if(h.type==='quiz'){ document.getElementById('prop-quiz-group').style.display='block'; }
            else if(h.type==='embed'){ document.getElementById('prop-embed-group').style.display='block'; document.getElementById('prop-embed-code').value=h.embedCode||''; }
            else if(h.type==='tts'){
                document.getElementById('prop-tts-group').style.display='block';
                const tts = h.ttsData || {};
                document.querySelector(`input[name="audioMode"][value="${tts.mode||'tts'}"]`).checked = true;
                toggleAudioMode();
                document.getElementById('prop-tts-content').value = tts.content||'';
                document.getElementById('prop-tts-lang').value = tts.lang||'zh-TW';
                document.getElementById('prop-tts-preset').value = tts.preset||'default';
                tempAudioBase64 = null;
                document.getElementById('audio-file-status').innerText = tts.audioSrc ? "âœ… ç›®å‰å·²æœ‰éŸ³æª”" : "å°šæœªä¸Šå‚³";
            }

            if(h.type==='quiz'||(h.type==='link'&&h.lockQuestion)){
                document.getElementById('prop-quiz-type').value=h.quizType||'choice';
                const opts = h.quizData.options || [];
                for(let i=0; i<4; i++) {
                    document.getElementById(`inp-opt-${i}`).value = opts[i] ? opts[i].t : '';
                    document.getElementById(`chk-opt-${i}`).checked = opts[i] ? opts[i].c : false;
                }
                document.getElementById('prop-fill-answer').value=h.quizData.fillAnswer||'';
                document.getElementById('prop-sort-answer').value=h.quizData.sortAnswer||'';
                document.getElementById('prop-quiz-feedback').value=h.quizData.feedback||'';
                if(tempQuizAudioBase64) h.quizData.audioSrc = tempQuizAudioBase64;
                document.getElementById('quiz-audio-status').innerText = h.quizData.audioSrc ? "âœ… ç›®å‰å·²æœ‰éŸ³æª”" : "";
            }
            if(h.type==='embed'){ h.embedCode=document.getElementById('prop-embed-code').value; }
            if(h.type==='tts'){
                h.ttsData.mode = document.querySelector('input[name="audioMode"]:checked').value;
                h.ttsData.content = document.getElementById('prop-tts-content').value;
                h.ttsData.lang = document.getElementById('prop-tts-lang').value;
                h.ttsData.preset = document.getElementById('prop-tts-preset').value;
                h.ttsData.pitch = parseFloat(document.getElementById('prop-tts-pitch').value) || 1;
                h.ttsData.rate = parseFloat(document.getElementById('prop-tts-rate').value) || 1;
                if(tempAudioBase64) h.ttsData.audioSrc = tempAudioBase64;
            }
            saveToLocal();renderHotspots();showToast("å·²å„²å­˜ï¼");
        }

        function updateQuizUI() {
            const t=document.getElementById('prop-quiz-type').value;
            document.getElementById('quiz-choice-inputs').style.display=t==='choice'?'block':'none';
            document.getElementById('quiz-fill-inputs').style.display=t==='fill'?'block':'none';
            document.getElementById('quiz-sort-inputs').style.display=t==='sort'?'block':'none';
        }
        function toggleLinkLock(){ 
            const l=document.getElementById('prop-link-lock').checked;
            document.getElementById('prop-quiz-group').style.display=l?'block':'none'; 
        }

        function toggleAudioMode() {
            const mode = document.querySelector('input[name="audioMode"]:checked').value;
            document.getElementById('mode-tts-panel').style.display = mode === 'tts' ? 'block' : 'none';
            document.getElementById('mode-upload-panel').style.display = mode === 'upload' ? 'block' : 'none';
            document.getElementById('mode-record-panel').style.display = mode === 'record' ? 'block' : 'none';
        }

        function applyVoicePreset() {
            const preset = document.getElementById('prop-tts-preset').value;
            const map = { 'default': { p: 1, r: 1 }, 'm1': { p: 0.7, r: 0.9 }, 'm2': { p: 0.9, r: 1.1 }, 'f1': { p: 1.2, r: 1.0 }, 'f2': { p: 1.6, r: 1.2 } };
            const settings = map[preset] || map['default'];
            document.getElementById('prop-tts-pitch').value = settings.p;
            document.getElementById('prop-tts-rate').value = settings.r;
        }

        function handleAudioUpload(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { tempAudioBase64 = e.target.result; document.getElementById('audio-file-status').innerText = "âœ… æº–å‚™å„²å­˜: " + file.name; };
            reader.readAsDataURL(file);
        }
        function handleQuizAudioUpload(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { tempQuizAudioBase64 = e.target.result; document.getElementById('quiz-audio-status').innerText = "âœ… æº–å‚™å„²å­˜: " + file.name; };
            reader.readAsDataURL(file);
        }
        function handleInfoImgUpload(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { tempInfoImgBase64 = e.target.result; document.getElementById('info-img-status').innerText = "âœ… æº–å‚™å„²å­˜: " + file.name; };
            reader.readAsDataURL(file);
        }
        function handleInfoVideoUpload(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { tempInfoVideoBase64 = e.target.result; document.getElementById('info-video-status').innerText = "âœ… æº–å‚™å„²å­˜: " + file.name; };
            reader.readAsDataURL(file);
        }
        
        function deleteAudio(type) {
            const s=projectData.scenes.find(x=>x.id===currentSceneId);
            const h=s.hotspots.find(x=>x.id===selectedHotspotId);
            if (!h) return;
            
            if (type === 'tts') {
                tempAudioBase64 = null;
                if (h.ttsData) h.ttsData.audioSrc = null;
                document.getElementById('audio-file-status').innerText = "å°šæœªä¸Šå‚³";
                document.getElementById('record-status').innerText = "";
            } else if (type === 'quiz') {
                tempQuizAudioBase64 = null;
                if (h.quizData) h.quizData.audioSrc = null;
                document.getElementById('quiz-audio-status').innerText = "";
            }
            saveToLocal();
            showToast("éŸ³æª”å·²åˆªé™¤");
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' }); 
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        tempAudioBase64 = reader.result;
                        document.getElementById('record-status').innerText = "âœ… éŒ„è£½å®Œæˆï¼(è«‹æŒ‰å„²å­˜)";
                        document.getElementById('record-status').style.color = "green";
                    };
                };
                mediaRecorder.start();
                document.getElementById('btn-record-start').classList.add('recording');
                document.getElementById('btn-record-start').disabled = true;
                document.getElementById('btn-record-stop').disabled = false;
                document.getElementById('record-status').innerText = "ğŸ”´ éŒ„éŸ³ä¸­...";
            } catch (err) { alert("éŒ„éŸ³å¤±æ•—: " + err); }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                document.getElementById('btn-record-start').classList.remove('recording');
                document.getElementById('btn-record-start').disabled = false;
                document.getElementById('btn-record-stop').disabled = true;
            }
        }

        function saveHotspotChanges() {
            if(!selectedHotspotId)return;
            const s=projectData.scenes.find(x=>x.id===currentSceneId), h=s.hotspots.find(x=>x.id===selectedHotspotId);
            h.text=document.getElementById('prop-text').value;
            // Get fresh target select value
            const tSelect = document.getElementById('prop-target');
            if(h.type==='link'){ h.targetScene=tSelect.value; h.lockQuestion=document.getElementById('prop-link-lock').checked; }
            
            if(h.type==='info'){
                if(!h.infoData) h.infoData = {};
                if(tempInfoImgBase64) h.infoData.imageSrc = tempInfoImgBase64;
                if(tempInfoVideoBase64) h.infoData.videoSrc = tempInfoVideoBase64;
            }

            if(h.type==='quiz'||(h.type==='link'&&h.lockQuestion)){
                h.quizType=document.getElementById('prop-quiz-type').value;
                h.quizData.options = [];
                for(let i=0; i<4; i++){
                    const txt = document.getElementById(`inp-opt-${i}`).value;
                    if(txt) h.quizData.options.push({ t: txt, c: document.getElementById(`chk-opt-${i}`).checked });
                }
                h.quizData.fillAnswer=document.getElementById('prop-fill-answer').value;
                h.quizData.sortAnswer=document.getElementById('prop-sort-answer').value;
                h.quizData.feedback=document.getElementById('prop-quiz-feedback').value;
                if(tempQuizAudioBase64) h.quizData.audioSrc = tempQuizAudioBase64;
            }
            if(h.type==='embed'){ h.embedCode=document.getElementById('prop-embed-code').value; }
            if(h.type==='tts'){
                h.ttsData.mode = document.querySelector('input[name="audioMode"]:checked').value;
                h.ttsData.content = document.getElementById('prop-tts-content').value;
                h.ttsData.lang = document.getElementById('prop-tts-lang').value;
                h.ttsData.preset = document.getElementById('prop-tts-preset').value;
                h.ttsData.pitch = parseFloat(document.getElementById('prop-tts-pitch').value) || 1;
                h.ttsData.rate = parseFloat(document.getElementById('prop-tts-rate').value) || 1;
                if(tempAudioBase64) h.ttsData.audioSrc = tempAudioBase64;
            }
            saveToLocal();renderHotspots();showToast("å·²å„²å­˜ï¼");
        }

        function deleteSelectedHotspot() {
            const s=projectData.scenes.find(x=>x.id===currentSceneId);
            s.hotspots=s.hotspots.filter(x=>x.id!==selectedHotspotId);
            saveToLocal();renderHotspots();deselectHotspot();showToast("å·²åˆªé™¤ï¼");
        }
        function deselectHotspot() { selectedHotspotId=null; propertiesPanel.style.display='none'; noSelectionMsg.style.display='block'; }

        function previewTTS() {
            const txt = document.getElementById('prop-tts-content').value;
            const lang = document.getElementById('prop-tts-lang').value;
            const pitch = parseFloat(document.getElementById('prop-tts-pitch').value);
            const rate = parseFloat(document.getElementById('prop-tts-rate').value);
            const preset = document.getElementById('prop-tts-preset').value;
            speak(txt, lang, pitch, rate, preset);
        }
        function stopTTS() { 
            window.speechSynthesis.cancel();
            if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; currentAudioObj = null; } 
        }
        function previewUploadedAudio() { 
            const src = tempAudioBase64; if(!src) { alert("å°šæœªæœ‰éŸ³æª”"); return; } 
            if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; currentAudioObj = null; } 
            currentAudioObj = new Audio(src); currentAudioObj.play(); 
        }

        function getBestVoice(l, p) {
            const lvs = availableVoices.filter(v => v.lang.replace('_','-').includes(l.split('-')[0]));
            if (lvs.length === 0 || p === 'default') return null;
            const fk = ['female', 'woman', 'zira', 'samantha', 'huihui', 'yaoyao', 'kaho', 'kyoko', 'mei-jia', 'hanhan']; 
            const mk = ['male', 'man', 'david', 'mark', 'danny', 'zhiwei'];
            const isF = p.startsWith('f');
            let cands = lvs.filter(v => { const n = v.name.toLowerCase(); return isF ? fk.some(k => n.includes(k)) : mk.some(k => n.includes(k)); });
            if (cands.length === 0) { const im = { 'm1': 0, 'f1': 1, 'm2': 2, 'f2': 3 }; const idx = im[p] || 0; return lvs[idx % lvs.length]; }
            const si = p.endsWith('2') ? 1 : 0; return cands[si % cands.length];
        }
        function speak(t,l,p,r,pre){
            if('speechSynthesis' in window){
                window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang=l;u.pitch=p;u.rate=r;
                if(pre&&availableVoices.length>0){const v=getBestVoice(l,pre);if(v)u.voice=v;}
                window.speechSynthesis.speak(u);
            } else { alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆï¼"); }
        }

        function togglePreviewMode() {
            isPreviewMode=!isPreviewMode;
            document.getElementById('editor-ui').style.visibility=isPreviewMode?'hidden':'visible';
            if(isPreviewMode){
                const b=document.createElement('button');b.innerText="âŒ é€€å‡ºé è¦½";b.id="exit-preview";
                b.style.cssText="position:absolute;top:20px;right:20px;z-index:999;padding:10px;";
                b.onclick=togglePreviewMode;document.body.appendChild(b);deselectHotspot();
            }else{ const b=document.getElementById('exit-preview');if(b)b.remove(); }
        }

        // --- ä¿®æ­£å¾Œçš„ YouTube åµŒå…¥é‚è¼¯ (ä½¿ç”¨ Cover Image ä¾†ç¹é Error 153) ---
        function parseEmbed(str) {
            if (!str) return '(ç„¡å…§å®¹)';
            let url = str.trim();

            // Extract Video ID
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);

            if (ytMatch && ytMatch[1]) {
                const vid = ytMatch[1];
                const coverUrl = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
                // ç”Ÿæˆå”¯ä¸€çš„ ID é¿å…è¡çª
                const uniqueId = 'yt-' + Math.random().toString(36).substr(2, 9);
                
                // é—œéµä¿®æ­£ï¼šé»æ“Šå¾Œæ‰è¼‰å…¥ iframeï¼Œä¸¦ä¸”ä½¿ç”¨ no-referrer éš±è—ä¾†æº
                // ä½¿ç”¨ onclick è§¸ç™¼è¼‰å…¥ï¼Œé€™æ˜¯ç¹éå¤§éƒ¨åˆ†é™åˆ¶çš„æœ€ä½³å¯¦è¸
                
                return `
                    <div id="${uniqueId}" class="yt-cover-container" onclick="window.loadYoutube('${uniqueId}', '${vid}')">
                        <img src="${coverUrl}" class="yt-cover-img">
                        <div class="yt-play-btn">
                            <div class="yt-play-triangle"></div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:8px; font-size:12px; color:#666;">
                        (å¦‚ç„¡æ³•æ’­æ”¾ï¼Œè«‹<a href="https://www.youtube.com/watch?v=${vid}" target="_blank" style="color:#0056b3; text-decoration:underline;">é»æ­¤å‰å¾€ YouTube è§€çœ‹</a>)
                    </div>
                `;
            }

            // 4. å…¶ä»–ç¶²å€ç›´æ¥å˜—è©¦åµŒå…¥
            if (url.startsWith('http')) {
                return `<iframe src="${url}" width="100%" height="400" frameborder="0" allowfullscreen style="border-radius:10px; border:2px solid #ccc;"></iframe>`;
            }
            
            return str;
        }

        function toggleLightbox(show, src) {
            const lb = document.getElementById('lightbox'); const img = document.getElementById('lightbox-img');
            if(show && src) { img.src = src; lb.style.display = 'flex'; } else { lb.style.display = 'none'; }
        }

        let currentAudioObj = null;
        function triggerHotspotAction(hs) {
            window.speechSynthesis.cancel();
            if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; currentAudioObj = null; }

            const o=document.getElementById('runtime-overlay'), ti=document.getElementById('overlay-title'), co=document.getElementById('overlay-content'), ac=document.getElementById('overlay-actions'), fb=document.getElementById('overlay-feedback');
            ac.innerHTML=''; fb.style.display='none'; o.style.display='block'; ti.innerText=hs.text; co.innerHTML='';

            if(hs.type==='info'){
                if(hs.infoData){
                    if(hs.infoData.imageSrc){const img = document.createElement('img'); img.src = hs.infoData.imageSrc; img.className = 'info-img-display'; img.onclick = () => toggleLightbox(true, hs.infoData.imageSrc); co.appendChild(img);}
                    if(hs.infoData.videoSrc){const vid = document.createElement('video'); vid.src = hs.infoData.videoSrc; vid.className = 'info-video-display'; vid.controls = true; co.appendChild(vid);}
                } return;
            }
            if(hs.type==='tts'){
                const mode = hs.ttsData.mode; 
                if ((mode === 'upload' || mode === 'record') && hs.ttsData.audioSrc) {
                    co.innerText = "ğŸµ æ’­æ”¾éŸ³æ•ˆä¸­...";
                    const bPlay = document.createElement('button'); bPlay.innerText="â–¶ æ’­æ”¾"; bPlay.className='save-btn';
                    bPlay.onclick = () => { if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; } currentAudioObj = new Audio(hs.ttsData.audioSrc); currentAudioObj.play(); };
                    const bStop = document.createElement('button'); bStop.innerText="â¹ åœæ­¢";
                    bStop.onclick = () => { if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; } };
                    ac.appendChild(bPlay); ac.appendChild(bStop);
                    if(currentAudioObj) { currentAudioObj.pause(); currentAudioObj.currentTime = 0; } currentAudioObj = new Audio(hs.ttsData.audioSrc); currentAudioObj.play();
                } else {
                    co.innerText = hs.ttsData.content;
                    const bPlay = document.createElement('button'); bPlay.innerText="â–¶ æ’­æ”¾"; bPlay.className='save-btn';
                    bPlay.onclick = () => speak(hs.ttsData.content, hs.ttsData.lang, hs.ttsData.pitch, hs.ttsData.rate, hs.ttsData.preset);
                    const bStop = document.createElement('button'); bStop.innerText="â¹ åœæ­¢";
                    bStop.onclick = () => window.speechSynthesis.cancel();
                    ac.appendChild(bPlay); ac.appendChild(bStop);
                    speak(hs.ttsData.content, hs.ttsData.lang, hs.ttsData.pitch, hs.ttsData.rate, hs.ttsData.preset);
                } return;
            }
            if(hs.type==='link'&&!hs.lockQuestion){ if(hs.targetScene)switchScene(hs.targetScene); else alert("æœªè¨­å®šç›®æ¨™å ´æ™¯"); o.style.display='none'; return; }
            if(hs.type==='embed'){ co.innerHTML = parseEmbed(hs.embedCode); return; }
            if(hs.type==='quiz'||(hs.type==='link'&&h.lockQuestion)){
                if(hs.type==='link') ti.innerText="ğŸ”’ é€šé—œå¯†èªï¼š"+hs.text;
                if(hs.quizData.audioSrc) {
                    const ad = document.createElement('div'); ad.style.marginBottom = '10px'; ad.style.padding = '5px'; ad.style.border = '1px solid #ccc'; ad.style.borderRadius = '5px';
                    ad.innerHTML = '<strong>ğŸ§ è½åŠ›æ’­æ”¾ï¼š</strong><br>';
                    const ae = document.createElement('audio'); ae.src = hs.quizData.audioSrc; ae.controls = true; ae.style.width = '100%';
                    ad.appendChild(ae); co.appendChild(ad);
                }
                const qt=hs.quizType||'choice';
                const success=()=>{ alert("ç­”å°äº†ï¼ğŸ‰"); o.style.display='none'; if(hs.type==='link'&&hs.targetScene)switchScene(hs.targetScene); };
                if(qt==='choice'){
                    const opts = hs.quizData.options || []; const shuf = opts.map((opt, i) => ({...opt, originalIdx: i})).sort(()=>Math.random()-.5); const selectionState = new Array(shuf.length).fill(false);
                    shuf.forEach((opt, idx) => {
                        const btn = document.createElement('button'); btn.className='quiz-option-btn'; btn.innerText = opt.t;
                        btn.onclick = () => { selectionState[idx] = !selectionState[idx]; btn.className = selectionState[idx] ? 'quiz-option-btn selected' : 'quiz-option-btn'; };
                        ac.appendChild(btn);
                    });
                    const subBtn = document.createElement('button'); subBtn.innerText="é€å‡ºç­”æ¡ˆ"; subBtn.className='save-btn';
                    subBtn.onclick = () => { let isCorrect = true; shuf.forEach((opt, idx) => { if (opt.c !== selectionState[idx]) isCorrect = false; }); if(isCorrect) success(); else { fb.innerText = hs.quizData.feedback||"ç­”éŒ¯å›‰ï¼"; fb.style.display='block'; } }; ac.appendChild(subBtn);
                } else if(qt==='fill'){
                    const i=document.createElement('input');i.placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ...";
                    const b=document.createElement('button');b.innerText="é€å‡º";b.className='save-btn';
                    b.onclick=()=>{ const userAns = i.value.trim(); const correctAnswers = (hs.quizData.fillAnswer||'').split(',').map(s=>s.trim()); if(correctAnswers.includes(userAns)) success(); else { fb.innerText = hs.quizData.feedback||"ä¸å°å–”ï¼"; fb.style.display='block'; } }; co.appendChild(i); ac.appendChild(b);
                } else if(qt==='sort'){
                    const cor=(hs.quizData.sortAnswer||'').split(',').map(s=>s.trim()); const shuf=[...cor].sort(()=>Math.random()-.5); let cur=[]; const ct=document.createElement('div');
                    const r=()=>{ ct.innerHTML=''; shuf.forEach(it=>{if(!cur.includes(it)){const b=document.createElement('button');b.innerText=it;b.style.width='auto';b.style.marginRight='5px';b.onclick=()=>{cur.push(it);r()};ct.appendChild(b);}}); const d=document.createElement('div');d.style.marginTop='10px';d.style.fontWeight='bold';d.innerText="ä½ çš„é †åº: "+cur.join(' > ');ct.appendChild(d); };
                    const rb=document.createElement('button');rb.innerText="Reset";rb.onclick=()=>{cur=[];r();fb.style.display='none'};
                    const sb=document.createElement('button');sb.innerText="Check";sb.className='save-btn';
                    sb.onclick=()=>{ if(cur.join(',')===cor.join(',')) success(); else { fb.innerText = hs.quizData.feedback||"é †åºä¸å°å–”ï¼"; fb.style.display='block'; } };
                    co.appendChild(rb);co.appendChild(ct);ac.appendChild(sb);r();
                }
            }
        }

        // Close Overlay logic
        function closeOverlay() {
            document.getElementById('runtime-overlay').style.display='none';
            document.getElementById('overlay-content').innerHTML=''; 
            
            // Stop TTS/SFX/Video but NOT BGM
            window.speechSynthesis.cancel();
            if(currentAudioObj) { 
                currentAudioObj.pause(); 
                currentAudioObj.currentTime = 0; 
                currentAudioObj = null; 
            }
        }

        // --- EXPORT PROJECT LOGIC (FIXED) ---
        function exportProject() {
            const filename = (projectData.title || 'vr-project') + '.html';

            // Clean Body Template for Player (Ensures fresh A-Frame init)
            const cleanBody = `
    <div id="splash-screen">
        <h1>ğŸ¨ ${projectData.title || 'VR æ•…äº‹'}</h1>
        <p>é»æ“Šé–‹å§‹ä»¥å•Ÿç”¨éŸ³æ•ˆ</p>
        <div class="splash-actions">
            <button id="splash-btn" onclick="startApp()">ğŸš€ é–‹å§‹é«”é©—</button>
        </div>
    </div>

    <div id="lightbox" onclick="toggleLightbox(false)">
        <img id="lightbox-img" src="">
    </div>

    <!-- Custom System Modal -->
    <div id="sys-modal">
        <div class="sys-modal-box">
            <div class="sys-modal-title" id="sys-title">æç¤º</div>
            <div class="sys-modal-msg" id="sys-msg">ç¢ºå®šåŸ·è¡Œå—ï¼Ÿ</div>
            <div class="sys-modal-btns">
                <button class="sys-btn sys-btn-cancel" onclick="closeSysModal()">å–æ¶ˆ</button>
                <button class="sys-btn sys-btn-ok" id="sys-ok-btn">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="bgm-player">
        <span id="bgm-icon">ğŸµ</span>
        <span id="bgm-status">BGM</span>
        <button id="bgm-toggle" onclick="toggleBGM()">â¸</button>
        <input type="range" id="bgm-vol" min="0" max="1" step="0.01" value="0.5" oninput="setBGMVolume(this.value)">
    </div>

    <a-scene id="vr-scene" raycaster="objects: .clickable, .raycast-target; interval: 0;" cursor="rayOrigin: mouse" vr-mode-ui="enabled: false">
        <a-sky id="sky-bg" color="#EEEEEE" class="raycast-target"></a-sky> 
        <a-entity id="rig" position="0 1.6 0"><a-entity id="camera" camera="zoom: 1" look-controls="reverseMouseDrag: true"></a-entity></a-entity>
        <a-entity id="hotspot-container"></a-entity>
    </a-scene>
    
    <div id="runtime-overlay" class="speech-bubble">
        <div class="close-btn" onclick="closeOverlay()">X</div>
        <div class="speech-content">
            <h2 id="overlay-title" style="color: #0056b3;">TITLE</h2>
            <div id="overlay-content" style="font-size: 18px; line-height: 1.5; margin-top:10px;"></div>
            <div id="overlay-feedback" style="color:red; font-weight:bold; margin-top:10px; display:none;"></div>
            <div id="overlay-actions" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="toast"></div>
    <div id="loading"><h1 style="font-size:32px;">è™•ç†ä¸­...</h1></div>
            `;

            // Data Injection (Safe method via window property)
            // Use URI encoding to prevent syntax errors
            const encodedData = encodeURIComponent(JSON.stringify(projectData));
            const dataScript = `
                window.exportedData = JSON.parse(decodeURIComponent("${encodedData}"));
            `;

            // Extract original script logic using ID
            const mainScript = document.getElementById('main-script');
            if (!mainScript) {
                alert("åŒ¯å‡ºéŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¸»ç¨‹å¼ç¢¼");
                return;
            }
            // Safely escape script closing tags
            const scriptContent = mainScript.innerHTML.replace(/<\/script>/gi, '<\\/script>');

            // Player Logic Overrides
            const playerLogic = `
                // --- Player Mode Initialization ---
                // Overwrite the initial empty state with exported data
                if(window.exportedData) {
                    projectData = window.exportedData;
                    isPreviewMode = true;
                }
                
                // Override DB loading to just use the memory data
                window.loadProjectFromDB = async function() {
                    if(projectData && projectData.scenes.length > 0) {
                        // Disable editor-only features
                        renderSceneList = function() {}; 
                        switchScene(projectData.scenes[0].id);
                        console.log("Player Loaded from Export");
                    }
                };
                
                // Disable editor functions
                window.saveToLocal = async function() {};
                window.importProject = async function() {};
                window.deleteScene = async function() {};
                window.resetProject = async function() {};
                // Stub out UI functions that don't exist in export
                window.deselectHotspot = function() {}; 
                window.selectHotspot = function() {};
                window.handleImageUpload = async function() {};
                window.triggerUpload = function() {};
                // Stub out drag/drop functions for player mode
                window.dragStart = function() {};
                window.dragOver = function() {};
                window.dragEnter = function() {};
                window.dragLeave = function() {};
                window.dragDrop = function() {};
                window.dragEnd = function() {};
            `;

            // Build final HTML string via array join to avoid nested backtick issues
            const htmlParts = [];
            htmlParts.push('<!DOCTYPE html>\n<html lang="zh-TW">\n<head>\n');
            htmlParts.push('<meta charset="UTF-8">\n');
            htmlParts.push('<meta name="viewport" content="width=device-width, initial-scale=1.0">\n');
            htmlParts.push('<meta name="referrer" content="no-referrer">\n'); // FIX: Changed to no-referrer for consistency
            htmlParts.push('<title>' + (projectData.title || 'VR Story') + '</title>\n');
            htmlParts.push('<script src="https://aframe.io/releases/1.4.0/aframe.min.js"><\/script>\n');
            htmlParts.push('<script>\n');
            htmlParts.push('if (typeof AFRAME !== "undefined") {\n');
            htmlParts.push('AFRAME.registerComponent("look-at", {\n');
            htmlParts.push('schema: { type: "selector" },\n');
            htmlParts.push('init: function () {},\n');
            htmlParts.push('tick: function () { if (this.data) { this.el.object3D.lookAt(this.data.object3D.position); } }\n');
            htmlParts.push('});\n');
            htmlParts.push('}\n');
            htmlParts.push('<\/script>\n');
            
            // Style
            const styleEl = document.getElementById('main-style') || document.querySelector('style');
            if (styleEl) {
                htmlParts.push('<style>\n' + styleEl.innerHTML + '\n#editor-ui { display: none !important; }\n</style>\n');
            } else {
                 htmlParts.push('<style>\n#editor-ui { display: none !important; }\n</style>\n');
            }
            
            htmlParts.push('</head>\n<body>\n');
            htmlParts.push(cleanBody);
            
            // Main Script
            htmlParts.push('\n<script id="main-script">\n');
            htmlParts.push(scriptContent);
            htmlParts.push('\n<\/script>\n');
            
            // Data and Logic
            htmlParts.push('\n<script>\n');
            htmlParts.push(dataScript);
            htmlParts.push(playerLogic);
            htmlParts.push('\n<\/script>\n');
            
            htmlParts.push('</body>\n</html>');

            const blob = new Blob([htmlParts.join('')], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
